{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã - –¢—Ä–µ–∫–µ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h1>
        <div>
            <button class="btn btn-outline-secondary me-2" onclick="resetSettings()">
                <i class="bi bi-arrow-counterclockwise"></i> –°–±—Ä–æ—Å–∏—Ç—å
            </button>
            <button class="btn btn-success" onclick="saveSettings()">
                <i class="bi bi-check-lg"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>
    </div>
    
    <!-- Alert –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="alert-container"></div>
    
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bell"></i> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–¥–µ—Ä–∂–∫–∞—Ö
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="notifications_enabled">
                        <label class="form-check-label" for="notifications_enabled">
                            <strong>–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</strong>
                        </label>
                        <div class="form-text">
                            –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <label for="notification_delay_1" class="form-label">
                                ‚ö†Ô∏è –ü–µ—Ä–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="notification_delay_1" 
                                       min="1" max="120" value="15">
                                <span class="input-group-text">–º–∏–Ω</span>
                            </div>
                            <div class="form-text">–æ—Ç 1 –¥–æ 120 –º–∏–Ω—É—Ç</div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="notification_delay_2" class="form-label">
                                üö® –í—Ç–æ—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="notification_delay_2" 
                                       min="5" max="180" value="30">
                                <span class="input-group-text">–º–∏–Ω</span>
                            </div>
                            <div class="form-text">–±–æ–ª—å—à–µ –ø–µ—Ä–≤–æ–≥–æ, –¥–æ 180 –º–∏–Ω</div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="notification_delay_3" class="form-label">
                                üî¥ –¢—Ä–µ—Ç—å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="notification_delay_3" 
                                       min="10" max="300" value="60">
                                <span class="input-group-text">–º–∏–Ω</span>
                            </div>
                            <div class="form-text">–±–æ–ª—å—à–µ –≤—Ç–æ—Ä–æ–≥–æ, –¥–æ 300 –º–∏–Ω</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i>
                        <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ª–∏—á–∫—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞.
                    </div>
                </div>
            </div>
            
            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up"></i> –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="daily_reports_enabled">
                        <label class="form-check-label" for="daily_reports_enabled">
                            <strong>–í–∫–ª—é—á–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã</strong>
                        </label>
                        <div class="form-text">
                            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –¥–µ–Ω—å
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="daily_reports_time" class="form-label">
                                üïê –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                            </label>
                            <input type="time" class="form-control" id="daily_reports_time" value="18:00">
                            <div class="form-text">–í —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç –æ—Ç—á–µ—Ç—ã –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ü—Ä–µ–≤—å—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-eye"></i> –ü—Ä–µ–≤—å—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="notification-preview first">
                            <div class="preview-icon">‚ö†Ô∏è</div>
                            <div class="preview-text">
                                <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong><br>
                                –í—ã –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ <span id="preview-delay-1">15</span> –º–∏–Ω—É—Ç!
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="notification-preview second">
                            <div class="preview-icon">üö®</div>
                            <div class="preview-text">
                                <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong><br>
                                –í—ã –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ <span id="preview-delay-2">30</span> –º–∏–Ω—É—Ç!
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="notification-preview third">
                            <div class="preview-icon">üî¥</div>
                            <div class="preview-text">
                                <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong><br>
                                –í—ã –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ <span id="preview-delay-3">60</span> –º–∏–Ω—É—Ç!
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-muted small">
                        <i class="bi bi-info-circle"></i>
                        –¢–∞–∫ –±—É–¥—É—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.notification-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    font-size: 14px;
}

.notification-preview.first {
    border-left: 4px solid #ffc107;
}

.notification-preview.second {
    border-left: 4px solid #fd7e14;
}

.notification-preview.third {
    border-left: 4px solid #dc3545;
}

.preview-icon {
    font-size: 18px;
    flex-shrink: 0;
}

.preview-text {
    flex-grow: 1;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Check if admin
    if (!userInfo.is_admin) {
        window.location.href = '/dashboard';
    }
    
    let currentSettings = {};
    
    // Load settings on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadSettings();
        setupEventListeners();
    });
    
    // Load current settings
    async function loadSettings() {
        try {
            const response = await axios.get('/api/settings/');
            currentSettings = response.data;
            
            // Fill form fields
            document.getElementById('notification_delay_1').value = currentSettings.notification_delay_1;
            document.getElementById('notification_delay_2').value = currentSettings.notification_delay_2;
            document.getElementById('notification_delay_3').value = currentSettings.notification_delay_3;
            document.getElementById('notifications_enabled').checked = currentSettings.notifications_enabled;
            document.getElementById('daily_reports_enabled').checked = currentSettings.daily_reports_enabled;
            document.getElementById('daily_reports_time').value = currentSettings.daily_reports_time;
            
            updatePreview();
            
        } catch (error) {
            console.error('Error loading settings:', error);
            showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'danger');
        }
    }
    
    // Setup event listeners for real-time preview
    function setupEventListeners() {
        document.getElementById('notification_delay_1').addEventListener('input', updatePreview);
        document.getElementById('notification_delay_2').addEventListener('input', updatePreview);
        document.getElementById('notification_delay_3').addEventListener('input', updatePreview);
    }
    
    // Update preview text
    function updatePreview() {
        const delay1 = document.getElementById('notification_delay_1').value;
        const delay2 = document.getElementById('notification_delay_2').value;
        const delay3 = document.getElementById('notification_delay_3').value;
        
        document.getElementById('preview-delay-1').textContent = delay1;
        document.getElementById('preview-delay-2').textContent = delay2;
        document.getElementById('preview-delay-3').textContent = delay3;
    }
    
    // Save settings
    async function saveSettings() {
        const data = {
            notification_delay_1: parseInt(document.getElementById('notification_delay_1').value),
            notification_delay_2: parseInt(document.getElementById('notification_delay_2').value),
            notification_delay_3: parseInt(document.getElementById('notification_delay_3').value),
            notifications_enabled: document.getElementById('notifications_enabled').checked,
            daily_reports_enabled: document.getElementById('daily_reports_enabled').checked,
            daily_reports_time: document.getElementById('daily_reports_time').value
        };
        
        // Validation
        if (data.notification_delay_1 <= 0 || data.notification_delay_1 > 120) {
            showAlert('–ü–µ—Ä–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 120 –º–∏–Ω—É—Ç', 'warning');
            return;
        }
        
        if (data.notification_delay_2 <= data.notification_delay_1 || data.notification_delay_2 > 180) {
            showAlert('–í—Ç–æ—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –ø–µ—Ä–≤–æ–≥–æ –∏ –Ω–µ –±–æ–ª–µ–µ 180 –º–∏–Ω—É—Ç', 'warning');
            return;
        }
        
        if (data.notification_delay_3 <= data.notification_delay_2 || data.notification_delay_3 > 300) {
            showAlert('–¢—Ä–µ—Ç—å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –≤—Ç–æ—Ä–æ–≥–æ –∏ –Ω–µ –±–æ–ª–µ–µ 300 –º–∏–Ω—É—Ç', 'warning');
            return;
        }
        
        try {
            await axios.put('/api/settings/', data);
            showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
            currentSettings = data;
        } catch (error) {
            console.error('Error saving settings:', error);
            showAlert(error.response?.data?.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'danger');
        }
    }
    
    // Reset settings to defaults
    async function resetSettings() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
            return;
        }
        
        try {
            await axios.post('/api/settings/reset');
            showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é', 'info');
            await loadSettings();
        } catch (error) {
            console.error('Error resetting settings:', error);
            showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'danger');
        }
    }
    
    // Show alert message
    function showAlert(message, type) {
        const alertContainer = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }
</script>
{% endblock %} 