{% extends "base.html" %}

{% block title %}Дашборд - Трекер активности{% endblock %}

{% block extra_css %}
<style>
    .welcome-admin-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-bottom: 30px;
        border-radius: 20px;
    }
    
    .period-buttons {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 10px;
    }
    
    .admin-stat-card {
        text-align: center;
        padding: 25px 20px;
        border-radius: 15px;
        position: relative;
        overflow: hidden;
        background: white;
        transition: all 0.3s ease;
    }
    
    .admin-stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .admin-stat-card.bg-primary { background: linear-gradient(135deg, #667eea, #764ba2) !important; }
    .admin-stat-card.bg-info { background: linear-gradient(135deg, #17a2b8, #138496) !important; }
    .admin-stat-card.bg-success { background: linear-gradient(135deg, #28a745, #20c997) !important; }
    .admin-stat-card.bg-danger { background: linear-gradient(135deg, #dc3545, #e83e8c) !important; }
    
    .admin-stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
        color: white;
    }
    
    .admin-stat-label {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1rem;
        font-weight: 500;
        margin-bottom: 0;
    }
    
    .admin-stat-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .metric-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
    }
    
    .metric-number {
        font-size: 3rem;
        font-weight: bold;
        margin: 15px 0;
    }
    
    .export-card {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-radius: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Приветствие админа -->
    <div class="card welcome-admin-card">
        <div class="card-body text-center">
            <h2><i class="fas fa-crown me-2"></i>Админ-панель</h2>
            <p class="lead mb-3">Общая статистика и управление системой мониторинга</p>
            <div class="period-buttons">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-light active" onclick="loadDashboard('today')">
                        <i class="fas fa-calendar-day me-1"></i>Сегодня
                    </button>
                    <button type="button" class="btn btn-outline-light" onclick="loadDashboard('week')">
                        <i class="fas fa-calendar-week me-1"></i>Неделя
                    </button>
                    <button type="button" class="btn btn-outline-light" onclick="loadDashboard('month')">
                        <i class="fas fa-calendar-alt me-1"></i>Месяц
                    </button>
                </div>
            </div>
            <p class="mt-3 mb-0">
                <i class="fas fa-clock me-1"></i>
                Последнее обновление: <span id="current-time"></span>
            </p>
        </div>
    </div>
    
    <!-- Loading spinner -->
    <div id="loadingSpinner" class="spinner-container">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    </div>
    
    <!-- Admin dashboard -->
    <div id="adminDashboard" style="display: none;">
        <!-- Основная статистика -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card admin-stat-card bg-primary h-100">
                    <div class="card-body">
                        <i class="fas fa-users admin-stat-icon"></i>
                        <div class="admin-stat-number" id="activeEmployees">0</div>
                        <div class="admin-stat-label">Активные сотрудники</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card admin-stat-card bg-info h-100">
                    <div class="card-body">
                        <i class="fas fa-envelope admin-stat-icon"></i>
                        <div class="admin-stat-number" id="totalMessagesToday">0</div>
                        <div class="admin-stat-label">Сообщений сегодня</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card admin-stat-card bg-success h-100">
                    <div class="card-body">
                        <i class="fas fa-check-circle admin-stat-icon"></i>
                        <div class="admin-stat-number" id="respondedToday">0</div>
                        <div class="admin-stat-label">Отвечено</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card admin-stat-card bg-danger h-100">
                    <div class="card-body">
                        <i class="fas fa-exclamation-triangle admin-stat-icon"></i>
                        <div class="admin-stat-number" id="urgentMessages">0</div>
                        <div class="admin-stat-label">Срочные сообщения</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Детальные метрики -->
        <div class="row mb-4">
            <div class="col-md-4 mb-4">
                <div class="card metric-card h-100">
                    <i class="fas fa-clock fa-2x primary mb-3"></i>
                    <h5 class="card-title">Среднее время ответа</h5>
                    <div class="metric-number primary" id="avgResponseTime">0</div>
                    <div class="text-muted">минут</div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card metric-card h-100">
                    <i class="fas fa-chart-line fa-2x success mb-3"></i>
                    <h5 class="card-title">Эффективность</h5>
                    <div class="metric-number success" id="efficiencyToday">0</div>
                    <div class="text-muted">процентов</div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card metric-card h-100">
                    <i class="fas fa-times-circle fa-2x danger mb-3"></i>
                    <h5 class="card-title">Пропущено</h5>
                    <div class="metric-number danger" id="missedToday">0</div>
                    <div class="text-muted">сообщений</div>
                </div>
            </div>
        </div>
        
        <!-- Google Sheets export -->
        <div class="row mb-4" id="googleSheetsSection" style="display: none;">
            <div class="col-12">
                <div class="card export-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="card-title text-white mb-2">
                                    <i class="fas fa-table me-2"></i>Экспорт в Google Sheets
                                </h5>
                                <p class="text-white mb-0">Выгрузите текущую статистику в Google Таблицы для дополнительного анализа</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-light btn-lg" onclick="exportToGoogleSheets()">
                                    <i class="fas fa-cloud-upload me-2"></i>Экспортировать
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Графики -->
    <div class="row" id="chartsSection" style="display: none;">
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>График времени ответа</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="responseTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Распределение сообщений</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="messagesPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPeriod = 'today';
    let responseTimeChart = null;
    let pieChart = null;
    
    // Обновление времени
    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleString('ru-RU');
    }
    
    // Load dashboard data
    async function loadDashboard(period = 'today') {
        currentPeriod = period;
        
        // Update active button
        document.querySelectorAll('.btn-group button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.toLowerCase().includes(period)) {
                btn.classList.add('active');
            }
        });
        
        try {
            const response = await axios.get('/api/dashboard/overview');
            const data = response.data;
            
            // Hide spinner
            document.getElementById('loadingSpinner').style.display = 'none';
            
            // Show admin dashboard
            document.getElementById('adminDashboard').style.display = 'block';
            
            // Update stats
            document.getElementById('activeEmployees').textContent = data.active_employees || 0;
            document.getElementById('totalMessagesToday').textContent = data.total_messages_today || 0;
            document.getElementById('respondedToday').textContent = data.responded_today || 0;
            document.getElementById('urgentMessages').textContent = data.urgent_messages || 0;
            document.getElementById('avgResponseTime').textContent = data.avg_response_time || 0;
            document.getElementById('efficiencyToday').textContent = data.efficiency_today || 0;
            document.getElementById('missedToday').textContent = data.missed_today || 0;
            
            // Check Google Sheets settings
            checkGoogleSheetsSettings();
            
            // Load charts
            await loadCharts();
            
        } catch (error) {
            console.error('Error loading dashboard:', error);
            showAlert('Ошибка при загрузке дашборда', 'danger');
        }
    }
    
    // Load charts
    async function loadCharts() {
        try {
            const response = await axios.get(`/api/statistics/charts/response-time?period=${currentPeriod === 'today' ? 'week' : 'month'}`);
            const data = response.data;
            
            // Show charts section
            document.getElementById('chartsSection').style.display = 'flex';
            
            // Response time chart
            const ctx1 = document.getElementById('responseTimeChart').getContext('2d');
            if (responseTimeChart) {
                responseTimeChart.destroy();
            }
            
            responseTimeChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Среднее время ответа (мин)',
                        data: data.data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#764ba2',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
            
            // Pie chart for message distribution
            const summaryResponse = await axios.get(`/api/statistics/summary?period=${currentPeriod}`);
            const summary = summaryResponse.data;
            
            const ctx2 = document.getElementById('messagesPieChart').getContext('2d');
            if (pieChart) {
                pieChart.destroy();
            }
            
            pieChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Отвечено', 'Пропущено'],
                    datasets: [{
                        data: [summary.responded_messages, summary.missed_messages],
                        backgroundColor: [
                            '#28a745',
                            '#dc3545'
                        ],
                        borderWidth: 0,
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
            
        } catch (error) {
            console.error('Error loading charts:', error);
        }
    }
    
    // Check Google Sheets settings
    async function checkGoogleSheetsSettings() {
        if (userInfo.is_admin) {
            try {
                const response = await axios.get('/api/dashboard/settings');
                if (response.data.google_sheets_enabled) {
                    document.getElementById('googleSheetsSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking settings:', error);
            }
        }
    }
    
    // Export to Google Sheets
    async function exportToGoogleSheets() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Экспорт...';
        
        try {
            const response = await axios.post(`/api/dashboard/export/google-sheets?period=${currentPeriod}`);
            showAlert('Данные успешно экспортированы!', 'success');
            
            if (response.data.sheet_url) {
                window.open(response.data.sheet_url, '_blank');
            }
        } catch (error) {
            console.error('Error exporting:', error);
            showAlert(error.response?.data?.detail || 'Ошибка при экспорте', 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    // Show alert
    function showAlert(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show notification`;
        alert.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.container-fluid').firstChild);
        
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        loadDashboard();
        
        // Автообновление каждые 5 минут
        setInterval(() => {
            loadDashboard(currentPeriod);
        }, 300000);
    });
</script>
{% endblock %} 