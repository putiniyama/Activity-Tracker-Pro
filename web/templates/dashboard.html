{% extends "base.html" %}

{% block title %}Дашборд - Activity Tracker Pro{% endblock %}

{% block extra_css %}
<style>
    /* Hero Section */
    .hero-section {
        background: var(--primary);
        border-radius: 30px;
        color: white;
        margin-bottom: 3rem;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(20px);
    }

    .hero-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
            radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
            radial-gradient(circle at 40% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
        animation: heroGlow 6s ease-in-out infinite alternate;
    }

    @keyframes heroGlow {
        0% {
            opacity: 0.5;
            transform: scale(1);
        }

        100% {
            opacity: 1;
            transform: scale(1.05);
        }
    }

    .hero-content {
        position: relative;
        z-index: 2;
        padding: 3rem;
    }

    .hero-title {
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 1rem;
        background: linear-gradient(45deg, #fff, rgba(255, 255, 255, 0.8));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .hero-subtitle {
        font-size: 1.25rem;
        opacity: 0.9;
        margin-bottom: 2rem;
    }

    /* Period Buttons */
    .period-selector {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        padding: 0.5rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .period-btn {
        background: transparent;
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 15px;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .period-btn.active,
    .period-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    /* Modern Stat Cards */
    .stat-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        padding: 2rem;
        position: relative;
        overflow: hidden;
    }

    [data-bs-theme="dark"] .stat-card {
        background: var(--dark-glass-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        border-radius: 25px 25px 0 0;
    }

    .stat-card.primary::before {
        background: var(--primary);
    }

    .stat-card.success::before {
        background: var(--success);
    }

    .stat-card.info::before {
        background: var(--info);
    }

    .stat-card.danger::before {
        background: var(--danger);
    }

    .stat-icon {
        width: 80px;
        height: 80px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin-bottom: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .stat-icon.primary {
        background: var(--primary);
    }

    .stat-icon.success {
        background: var(--success);
    }

    .stat-icon.info {
        background: var(--info);
    }

    .stat-icon.danger {
        background: var(--danger);
    }

    .stat-icon::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transform: rotate(45deg);
    }

    .stat-number {
        font-size: 3rem;
        font-weight: 800;
        margin: 1rem 0;
        font-family: 'JetBrains Mono', monospace;
    }

    .stat-label {
        font-size: 1.1rem;
        font-weight: 600;
        opacity: 0.8;
        margin-bottom: 0.5rem;
    }

    .stat-change {
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Metric Cards */
    .metric-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        padding: 2.5rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    [data-bs-theme="dark"] .metric-card {
        background: var(--dark-glass-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .metric-icon {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        font-size: 2.5rem;
        position: relative;
        overflow: hidden;
    }

    .metric-value {
        font-size: 4rem;
        font-weight: 800;
        margin: 1rem 0;
        font-family: 'JetBrains Mono', monospace;
        background: var(--primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Progress Ring */
    .progress-ring {
        width: 120px;
        height: 120px;
        margin: 0 auto 1rem;
    }

    .progress-ring circle {
        fill: none;
        stroke-width: 8;
        stroke-linecap: round;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        transition: stroke-dasharray 1s ease;
    }

    .progress-ring .bg {
        stroke: rgba(0, 0, 0, 0.1);
    }

    .progress-ring .progress {
        stroke: url(#gradient);
        stroke-dasharray: 0 314;
        animation: progressFill 2s ease-in-out;
    }

    @keyframes progressFill {
        from {
            stroke-dasharray: 0 314;
        }
    }

    /* Chart Cards */
    .chart-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        overflow: hidden;
    }

    [data-bs-theme="dark"] .chart-card {
        background: var(--dark-glass-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chart-header {
        background: var(--primary);
        color: white;
        padding: 1.5rem 2rem;
        font-weight: 600;
        position: relative;
    }

    .chart-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    }

    .chart-body {
        padding: 2rem;
    }

    /* Loading States */
    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 15px;
    }

    @keyframes loading {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    /* Status Indicators */
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .status-online {
        background: rgba(72, 187, 120, 0.2);
        color: #48bb78;
        border: 1px solid rgba(72, 187, 120, 0.3);
    }

    .status-warning {
        background: rgba(237, 137, 54, 0.2);
        color: #ed8936;
        border: 1px solid rgba(237, 137, 54, 0.3);
    }

    /* Floating Action Button */
    .fab {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        border: none;
        font-size: 1.5rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        z-index: 1000;
    }

    .fab:hover {
        transform: scale(1.1) rotate(10deg);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .hero-title {
            font-size: 2rem;
        }

        .stat-card {
            padding: 1.5rem;
        }

        .metric-card {
            padding: 2rem;
        }

        .stat-number,
        .metric-value {
            font-size: 2.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hero Section -->
    <div class="hero-section animate-fade-in">
        <div class="hero-content">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="hero-title">
                        <i class="fas fa-crown me-3"></i>Командный центр
                    </h1>
                    <p class="hero-subtitle">
                        Полный контроль над активностью команды в реальном времени
                    </p>
                    <div class="status-indicator status-online">
                        <div class="spinner-grow spinner-grow-sm" role="status"></div>
                        Система активна
                    </div>
                </div>
                <div class="col-lg-4 text-end">
                    <div class="period-selector">
                        <button class="period-btn active" onclick="changePeriod('today')">
                            <i class="fas fa-calendar-day me-2"></i>Сегодня
                        </button>
                        <button class="period-btn" onclick="changePeriod('week')">
                            <i class="fas fa-calendar-week me-2"></i>Неделя
                        </button>
                        <button class="period-btn" onclick="changePeriod('month')">
                            <i class="fas fa-calendar-alt me-2"></i>Месяц
                        </button>
                    </div>
                    <p class="mt-3 mb-0 small">
                        <i class="fas fa-sync-alt me-2"></i>
                        <span id="current-time"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingSpinner" class="text-center py-5">
        <div class="loading-dots">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
        <p class="mt-3 text-muted">Загрузка аналитики...</p>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" style="display: none;">
        <!-- Key Metrics -->
        <div class="row mb-5" id="keyMetrics">
            <div class="col-xl-3 col-lg-6 mb-4">
                <div class="stat-card primary animate-slide-up" style="animation-delay: 0.1s">
                    <div class="stat-icon primary">
                        <i class="fas fa-users text-white"></i>
                    </div>
                    <div class="stat-number primary" id="activeEmployees">0</div>
                    <div class="stat-label">Активная команда</div>
                    <div class="stat-change text-success">
                        <i class="fas fa-arrow-up"></i>
                        <span>+12% за неделю</span>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-lg-6 mb-4">
                <div class="stat-card info animate-slide-up" style="animation-delay: 0.2s">
                    <div class="stat-icon info">
                        <i class="fas fa-envelope text-white"></i>
                    </div>
                    <div class="stat-number info" id="totalMessagesToday">0</div>
                    <div class="stat-label" id="totalMessagesLabel">Обработано сегодня</div>
                    <div class="stat-change text-info">
                        <i class="fas fa-chart-line"></i>
                        <span>В тренде</span>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-lg-6 mb-4">
                <div class="stat-card success animate-slide-up" style="animation-delay: 0.3s">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle text-white"></i>
                    </div>
                    <div class="stat-number success" id="respondedToday">0</div>
                    <div class="stat-label" id="respondedLabel">Успешно отвечено</div>
                    <div class="stat-change text-success">
                        <i class="fas fa-arrow-up"></i>
                        <span>Отличная работа!</span>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-lg-6 mb-4">
                <div class="stat-card danger animate-slide-up" style="animation-delay: 0.4s">
                    <div class="stat-icon danger">
                        <i class="fas fa-pause-circle text-white"></i>
                    </div>
                    <div class="stat-number danger" id="deferredMessages">0</div>
                    <div class="stat-label">Отложено</div>
                    <div class="stat-change text-warning" id="deferredStatus" style="display:none;">
                        <i class="fas fa-pause-circle"></i>
                        <span>Отложено: <span id="deferredMessagesText">0</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="row mb-5">
            <div class="col-lg-3 mb-4">
                <div class="metric-card animate-slide-up" style="animation-delay: 0.5s">
                    <div class="metric-icon" style="background: var(--primary);">
                        <i class="fas fa-clock text-white"></i>
                    </div>
                    <h5>Среднее время ответа</h5>
                    <div class="metric-value" id="avgResponseTime">0</div>
                    <p class="text-muted mb-0">минут</p>

                    <!-- Progress Ring -->
                    <svg class="progress-ring" viewBox="0 0 120 120">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#667eea" />
                                <stop offset="100%" style="stop-color:#764ba2" />
                            </linearGradient>
                        </defs>
                        <circle class="bg" cx="60" cy="60" r="50"></circle>
                        <circle class="progress" cx="60" cy="60" r="50" id="timeProgress"></circle>
                    </svg>
                </div>
            </div>
            <div class="col-lg-3 mb-4">
                <div class="metric-card animate-slide-up" style="animation-delay: 0.6s">
                    <div class="metric-icon" style="background: var(--success);">
                        <i class="fas fa-chart-line text-white"></i>
                    </div>
                    <h5>Эффективность команды</h5>
                    <div class="metric-value" id="efficiencyToday">0</div>
                    <p class="text-muted mb-0">процентов</p>

                    <!-- Progress Ring -->
                    <svg class="progress-ring" viewBox="0 0 120 120">
                        <circle class="bg" cx="60" cy="60" r="50"></circle>
                        <circle class="progress" cx="60" cy="60" r="50" id="efficiencyProgress"></circle>
                    </svg>
                </div>
            </div>
            <div class="col-lg-3 mb-4">
                <div class="metric-card animate-slide-up" style="animation-delay: 0.7s">
                    <div class="metric-icon" style="background: var(--info);">
                        <i class="fas fa-user-friends text-white"></i>
                    </div>
                    <h5 id="uniqueClientsLabel">Уникальных клиентов</h5>
                    <div class="metric-value" id="uniqueClientsToday">0</div>
                    <p class="text-muted mb-0">обработано</p>

                    <!-- Progress Ring -->
                    <svg class="progress-ring" viewBox="0 0 120 120">
                        <circle class="bg" cx="60" cy="60" r="50"></circle>
                        <circle class="progress" cx="60" cy="60" r="50" id="clientsProgress"></circle>
                    </svg>
                </div>
            </div>
            <div class="col-lg-3 mb-4">
                <div class="metric-card animate-slide-up" style="animation-delay: 0.8s">
                    <div class="metric-icon" style="background: var(--warning);">
                        <i class="fas fa-times-circle text-white"></i>
                    </div>
                    <h5>Пропущено</h5>
                    <div class="metric-value" id="missedToday">0</div>
                    <p class="text-muted mb-0">сообщений</p>

                    <!-- Progress Ring -->
                    <svg class="progress-ring" viewBox="0 0 120 120">
                        <circle class="bg" cx="60" cy="60" r="50"></circle>
                        <circle class="progress" cx="60" cy="60" r="50" id="missedProgress"></circle>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row" id="chartsSection" style="display: none;">
            <div class="col-lg-8 mb-4">
                <div class="chart-card animate-slide-up" style="animation-delay: 0.9s">
                    <div class="chart-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>
                            Динамика времени ответа
                        </h5>
                    </div>
                    <div class="chart-body">
                        <canvas id="responseTimeChart" style="height: 400px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="chart-card animate-slide-up" style="animation-delay: 1s">
                    <div class="chart-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>
                            Распределение результатов
                        </h5>
                    </div>
                    <div class="chart-body">
                        <canvas id="messagesPieChart" style="height: 400px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="refreshDashboard()" title="Обновить данные">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- Модальное окно для отложенных сообщений -->
    <div class="modal fade" id="deferredMessagesModal" tabindex="-1" aria-labelledby="deferredMessagesModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deferredMessagesModalLabel">Отложенные сообщения</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Время</th>
                                    <th>Клиент</th>
                                    <th>Ссылка</th>
                                    <th>Текст</th>
                                    <th>Сотрудник</th>
                                    <th>Отложено (мин)</th>
                                    <th>Действие</th>
                                </tr>
                            </thead>
                            <tbody id="deferredMessagesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Загрузка...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPeriod = 'today';
    let responseTimeChart = null;
    let pieChart = null;
    let refreshInterval = null;

    // Update current time
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('current-time').textContent = `Обновлено в ${timeString}`;
    }

    // Change period
    function changePeriod(period) {
        loadDashboard(period);
    }

    // Update period labels based on selected period
    function updatePeriodLabels(period) {
        const labels = {
            today: {
                totalMessages: 'Получено сегодня',
                responded: 'Успешно отвечено',
                uniqueClients: 'Уникальных клиентов сегодня',
                efficiency: 'Эффективность сегодня',
                missed: 'Пропущено сегодня'
            },
            week: {
                totalMessages: 'Получено за неделю',
                responded: 'Успешно отвечено за неделю',
                uniqueClients: 'Уникальных клиентов за неделю',
                efficiency: 'Эффективность за неделю',
                missed: 'Пропущено за неделю'
            },
            month: {
                totalMessages: 'Получено за месяц',
                responded: 'Успешно отвечено за месяц',
                uniqueClients: 'Уникальных клиентов за месяц',
                efficiency: 'Эффективность за месяц',
                missed: 'Пропущено за месяц'
            }
        };

        const periodLabels = labels[period] || labels.today;

        // Обновляем надписи с проверкой существования элементов
        const totalMessagesLabel = document.getElementById('totalMessagesLabel');
        if (totalMessagesLabel) {
            totalMessagesLabel.textContent = periodLabels.totalMessages;
        }

        const respondedLabel = document.getElementById('respondedLabel');
        if (respondedLabel) {
            respondedLabel.textContent = periodLabels.responded;
        }

        const uniqueClientsLabel = document.getElementById('uniqueClientsLabel');
        if (uniqueClientsLabel) {
            uniqueClientsLabel.textContent = periodLabels.uniqueClients;
        }

        console.log(`📝 Labels updated for period: ${period}`);
    }

    // Set progress ring
    function setProgressRing(elementId, percentage) {
        const circle = document.getElementById(elementId);
        if (circle) {
            const circumference = 2 * Math.PI * 50;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            circle.style.strokeDashoffset = offset;
        }
    }

    // Load dashboard data
    async function loadDashboard(period = 'today') {
        console.log('🔄 Loading dashboard data for period:', period);
        currentPeriod = period;

        // Update period labels immediately
        updatePeriodLabels(period);

        // Update active button
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Find and activate correct button
        const buttons = document.querySelectorAll('.period-btn');
        buttons.forEach(btn => {
            if ((period === 'today' && btn.textContent.includes('Сегодня')) ||
                (period === 'week' && btn.textContent.includes('Неделя')) ||
                (period === 'month' && btn.textContent.includes('Месяц'))) {
                btn.classList.add('active');
            }
        });

        try {
            // Show loading state
            console.log('🔄 Showing loading state');
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';

            console.log('📡 Making API request to /api/dashboard/overview with period:', period);
            const response = await axios.get(`/api/dashboard/overview?period=${period}`);
            console.log('✅ API response received:', response.data);
            const data = response.data;

            // Детальное логирование получаемых данных
            console.log('📊 Received data breakdown:');
            console.log('  - active_employees:', data.active_employees);
            console.log('  - total_messages_today:', data.total_messages_today);
            console.log('  - responded_today:', data.responded_today);
            console.log('  - unique_clients_today:', data.unique_clients_today);
            console.log('  - urgent_messages:', data.urgent_messages);
            console.log('  - avg_response_time:', data.avg_response_time);
            console.log('  - efficiency_today:', data.efficiency_today);
            console.log('  - missed_today:', data.missed_today);

            // Hide loading and show content
            console.log('✅ Hiding loading, showing content');
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            // Update stats with animations - с проверкой элементов
            console.log('🎬 Starting number animations');

            // Проверяем наличие элементов и их текущие значения
            const elements = [
                'activeEmployees', 'totalMessagesToday', 'respondedToday',
                'uniqueClientsToday', 'avgResponseTime', 'efficiencyToday', 'missedToday'
            ];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    console.log(`  Element ${id}: found, current value = ${element.textContent}`);
                } else {
                    console.error(`  Element ${id}: NOT FOUND!`);
                }
            });

            // Анимируем числа с логированием
            console.log('🔢 Animating numbers:');
            console.log('  - activeEmployees:', data.active_employees || 0);
            animateNumber('activeEmployees', data.active_employees || 0);

            console.log('  - totalMessagesToday:', data.total_messages_today || 0);
            animateNumber('totalMessagesToday', data.total_messages_today || 0);

            console.log('  - respondedToday:', data.responded_today || 0);
            animateNumber('respondedToday', data.responded_today || 0);

            console.log('  - uniqueClientsToday:', data.unique_clients_today || 0);
            animateNumber('uniqueClientsToday', data.unique_clients_today || 0);

            // avgResponseTime — дробное число, 1 знак после запятой
            console.log('  - avgResponseTime:', data.avg_response_time || 0);
            animateNumber('avgResponseTime', data.avg_response_time || 0, true);

            console.log('  - efficiencyToday:', data.efficiency_today || 0);
            animateNumber('efficiencyToday', data.efficiency_today || 0);

            console.log('  - missedToday:', data.missed_today || 0);
            animateNumber('missedToday', data.missed_today || 0);

            // Update progress rings
            setTimeout(() => {
                console.log('⭕ Updating progress rings');
                const maxTime = 60; // Max expected response time
                const timePercentage = Math.min((data.avg_response_time || 0) / maxTime * 100, 100);
                console.log('  - timeProgress percentage:', timePercentage);
                setProgressRing('timeProgress', timePercentage);

                console.log('  - efficiencyProgress percentage:', data.efficiency_today || 0);
                setProgressRing('efficiencyProgress', data.efficiency_today || 0);

                // Прогресс уникальных клиентов (относительно общего количества сообщений)
                const totalMessages = data.total_messages_today || 1;
                const clientsPercentage = Math.min((data.unique_clients_today || 0) / totalMessages * 100, 100);
                console.log('  - clientsProgress percentage:', clientsPercentage);
                setProgressRing('clientsProgress', clientsPercentage);

                const missedPercentage = (data.missed_today || 0) / totalMessages * 100;
                console.log('  - missedProgress percentage:', missedPercentage);
                setProgressRing('missedProgress', missedPercentage);
            }, 1000);

            // Обновление блока отложенных
            const deferredStatus = document.getElementById('deferredStatus');
            const deferredMessages = document.getElementById('deferredMessages');
            const deferredMessagesText = document.getElementById('deferredMessagesText');
            if (deferredMessages) {
                deferredMessages.textContent = data.deferred_messages || 0;
            }
            if (deferredMessagesText) {
                deferredMessagesText.textContent = data.deferred_messages || 0;
            }
            if (deferredStatus) {
                if (data.deferred_messages > 0) {
                    deferredStatus.style.display = '';
                } else {
                    deferredStatus.style.display = 'none';
                }
            }

            // Load charts
            console.log('📊 Loading charts');
            await loadCharts();

            // Вызываем updateActiveTeamDelta после загрузки дашборда
            await updateActiveTeamDelta();

            console.log('✅ Dashboard loaded successfully');

        } catch (error) {
            console.error('❌ Error loading dashboard:', error);
            console.error('Error details:', error.response?.data || error.message);

            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            // Show fallback data
            console.log('⚠️ Showing fallback data');
            animateNumber('activeEmployees', 0);
            animateNumber('totalMessagesToday', 0);
            animateNumber('respondedToday', 0);
            animateNumber('missedToday', 0);

        }
    }

    // Animate numbers
    function animateNumber(elementId, targetValue, isFloat = false) {
        const element = document.getElementById(elementId);
        if (!element) {
            console.error(`❌ animateNumber: Element ${elementId} not found!`);
            return;
        }

        const startValue = isFloat ? parseFloat(element.textContent.replace(',', '.')) || 0 : parseInt(element.textContent) || 0;
        console.log(`🎯 animateNumber ${elementId}: ${startValue} → ${targetValue}`);

        // Если значения одинаковые, просто обновляем без анимации
        if (startValue === targetValue) {
            console.log(`⚡ animateNumber ${elementId}: values are the same, no animation needed`);
            element.textContent = isFloat ? Number(targetValue).toFixed(1) : targetValue;
            return;
        }

        const duration = 1000;
        const startTime = performance.now();

        function updateNumber(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // Easing function
            const easeOut = 1 - Math.pow(1 - progress, 3);
            const currentValue = startValue + (targetValue - startValue) * easeOut;

            if (isFloat) {
                element.textContent = Number(currentValue).toFixed(1);
            } else {
                element.textContent = Math.round(currentValue);
            }

            if (progress < 1) {
                requestAnimationFrame(updateNumber);
            } else {
                console.log(`✅ animateNumber ${elementId}: animation completed, final value = ${isFloat ? Number(targetValue).toFixed(1) : targetValue}`);
            }
        }

        requestAnimationFrame(updateNumber);
    }

    // Load charts with modern styling
    async function loadCharts() {
        try {
            console.log('📊 Loading charts data...');
            const chartResponse = await axios.get(`/api/statistics/charts/response-time?period=${currentPeriod === 'today' ? 'week' : 'month'}`);
            console.log('📊 Chart response:', chartResponse.data);
            const chartData = chartResponse.data;

            // Извлекаем labels и data из ответа API
            const labels = chartData.data.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('ru-RU', {
                    month: 'short',
                    day: 'numeric'
                });
            });
            const responseTimeData = chartData.data.map(item => item.avg_response_time);

            console.log('📊 Processed chart data:');
            console.log('  - labels:', labels);
            console.log('  - data:', responseTimeData);

            document.getElementById('chartsSection').style.display = 'flex';

            // Modern gradient colors
            const gradientBlue = {
                start: '#667eea',
                end: '#764ba2'
            };

            const gradientGreen = {
                start: '#4facfe',
                end: '#00f2fe'
            };

            // Response time chart
            const ctx1 = document.getElementById('responseTimeChart').getContext('2d');
            if (responseTimeChart) {
                responseTimeChart.destroy();
            }

            const gradient = ctx1.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(102, 126, 234, 0.3)');
            gradient.addColorStop(1, 'rgba(102, 126, 234, 0.05)');

            console.log('📊 Creating chart with Chart.js...');
            responseTimeChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Время ответа (мин)',
                        data: responseTimeData,
                        borderColor: gradientBlue.start,
                        backgroundColor: gradient,
                        tension: 0.4,
                        borderWidth: 4,
                        pointBackgroundColor: gradientBlue.end,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        pointRadius: 8,
                        pointHoverRadius: 12,
                        fill: true,
                        shadowColor: 'rgba(102, 126, 234, 0.3)',
                        shadowBlur: 15,
                        shadowOffsetY: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: gradientBlue.start,
                            borderWidth: 2,
                            cornerRadius: 15,
                            displayColors: false,
                            callbacks: {
                                title: (items) => `Дата: ${items[0].label}`,
                                label: (item) => `Время ответа: ${item.formattedValue} мин`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: {
                                    size: 12,
                                    weight: 500
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: {
                                    size: 12,
                                    weight: 500
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutQuart'
                    }
                }
            });

            console.log('✅ Line chart created successfully');

            // Pie chart
            console.log('📊 Loading pie chart data...');
            const summaryResponse = await axios.get(`/api/statistics/summary?period=${currentPeriod}`);
            console.log('📊 Summary response:', summaryResponse.data);
            const summaryData = summaryResponse.data;

            const ctx2 = document.getElementById('messagesPieChart').getContext('2d');
            if (pieChart) {
                pieChart.destroy();
            }

            pieChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Отвечено', 'Пропущено', 'В обработке'],
                    datasets: [{
                        data: [
                            summaryData.responded_messages || 0,
                            summaryData.missed_messages || 0,
                            (summaryData.total_messages || 0) - (summaryData.responded_messages || 0) - (summaryData.missed_messages || 0)
                        ],
                        backgroundColor: [
                            gradientGreen.start,
                            '#ff6b9d',
                            '#feca57'
                        ],
                        borderWidth: 0,
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                padding: 25,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    size: 14,
                                    weight: 600
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderWidth: 0,
                            cornerRadius: 15,
                            displayColors: false
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutBounce'
                    }
                }
            });

            console.log('✅ Pie chart created successfully');

        } catch (error) {
            console.error('❌ Error loading charts:', error);
            console.error('Error details:', error.response?.data || error.message);
        }
    }

    // Refresh dashboard
    function refreshDashboard() {
        const fab = document.querySelector('.fab');
        const originalTransform = fab.style.transform;

        fab.style.transform = 'scale(1.2) rotate(360deg)';

        setTimeout(() => {
            fab.style.transform = originalTransform;
            loadDashboard(currentPeriod);
        }, 300);
    }

    // Auto refresh every 10 minutes
    function startAutoRefresh() {
        refreshInterval = setInterval(() => {
            loadDashboard(currentPeriod);
        }, 600000); // 10 minutes вместо 5
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
        // Start time updates
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // Initial load - ensure dashboard content is hidden during loading
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('dashboardContent').style.display = 'none';

        // Load dashboard data automatically
        setTimeout(() => {
            loadDashboard('today');
        }, 100); // Small delay to ensure DOM is ready

        // Auto refresh every 10 minutes
        startAutoRefresh();

        // Убираем тяжелые анимации
        document.querySelectorAll('.stat-card, .metric-card, .chart-card').forEach(card => {
            card.style.opacity = '1';
            card.style.transform = 'none';
        });

        // Открытие модального окна по клику на карточку "Отложено"
        const deferredCard = document.querySelector('.stat-card.danger');
        if (deferredCard) {
            deferredCard.style.cursor = 'pointer';
            deferredCard.addEventListener('click', function () {
                const modal = new bootstrap.Modal(document.getElementById('deferredMessagesModal'));
                loadDeferredMessages();
                modal.show();
            });
        }
        // Гарантируем загрузку отложенных сообщений при любом открытии модального окна (например, через show())
        const deferredModal = document.getElementById('deferredMessagesModal');
        if (deferredModal) {
            deferredModal.addEventListener('show.bs.modal', function () {
                loadDeferredMessages();
            });
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });

    // Функция для обновления прироста активной команды
    async function updateActiveTeamDelta() {
        try {
            const response = await axios.get('/api/statistics/employees/active-delta');
            const activeToday = response.data.active_today || 0;
            const activeWeek = response.data.active_week || 0;

            let delta = 0;
            if (activeWeek > 0) {
                delta = Math.round(((activeToday - activeWeek) / activeWeek) * 100);
            } else if (activeToday > 0) {
                delta = 100;
            }

            const statCard = document.querySelector('#activeEmployees').closest('.stat-card');
            const deltaElement = statCard.querySelector('.stat-change span');

            deltaElement.innerHTML = `${delta >= 0 ? '+' : ''}${delta}% за неделю`;
            deltaElement.parentElement.classList.toggle('text-success', delta >= 0);
            deltaElement.parentElement.classList.toggle('text-danger', delta < 0);
        } catch (error) {
            console.error('Ошибка при обновлении прироста команды:', error);
        }
    }

    // Загрузка отложенных сообщений
    async function loadDeferredMessages() {
        const tbody = document.getElementById('deferredMessagesTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Загрузка...</td></tr>';
        try {
            const resp = await axios.get('/api/statistics/deferred-messages');
            const data = resp.data;
            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Нет отложенных сообщений</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(msg => `
                <tr>
                    <td>${msg.received_at ? new Date(msg.received_at).toLocaleString('ru-RU') : '-'}</td>
                    <td>${msg.client_name || msg.client_username || msg.client_telegram_id || '-'}</td>
                    <td>${msg.client_username ? `<a href='https://t.me/${msg.client_username}' target='_blank'>@${msg.client_username}</a>` : ''}</td>
                    <td class='text-truncate' style='max-width:300px' title='${msg.message_text || ''}'>${msg.message_text ? msg.message_text.substring(0, 80) + (msg.message_text.length > 80 ? '...' : '') : '-'}</td>
                    <td>${msg.answered_by_name || msg.employee_name || '-'}</td>
                    <td>${msg.deferred_minutes != null ? msg.deferred_minutes : '-'}</td>
                    <td><button class="btn btn-sm btn-success undefer-btn" data-id="${msg.id}">Снять</button></td>
                </tr>
            `).join('');
            // Вешаем обработчик на кнопки 'Снять'
            tbody.querySelectorAll('.undefer-btn').forEach(btn => {
                btn.addEventListener('click', async function () {
                    const messageId = this.getAttribute('data-id');
                    console.log('Нажата кнопка Снять для сообщения', messageId);
                    this.disabled = true;
                    try {
                        const resp = await axios.post('/api/statistics/undefer-deferred-simple', { message_id: Number(messageId) });
                        console.log('Ответ сервера:', resp.data);
                        if (resp.data.success) {
                            await loadDeferredMessages();
                        } else {
                            alert(resp.data.message || 'Ошибка');
                        }
                    } catch (e) {
                        alert('Ошибка при снятии с отложенных');
                        console.error(e);
                    }
                    this.disabled = false;
                });
            });
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Ошибка загрузки</td></tr>';
        }
    }
</script>
{% endblock %}