{% extends "base.html" %}

{% block title %}Аналитика - Activity Tracker Pro{% endblock %}

{% block extra_css %}
<style>
    /* Hero Analytics Section */
    .analytics-hero {
        background: var(--secondary);
        border-radius: 30px;
        color: white;
        margin-bottom: 3rem;
        position: relative;
        overflow: hidden;
    }

    .analytics-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
        animation: analyticsGlow 8s ease-in-out infinite alternate;
    }

    @keyframes analyticsGlow {
        0% { opacity: 0.7; transform: scale(1); }
        100% { opacity: 1; transform: scale(1.02); }
    }

    .hero-content {
        position: relative;
        z-index: 2;
        padding: 3rem;
    }

    /* Modern Period Selector */
    .period-control {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        padding: 2rem;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
        overflow: visible;
    }

    [data-bs-theme="dark"] .period-control {
        background: var(--dark-glass-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .period-control:hover {
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        transform: none !important;
    }

    .form-control, .form-select {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid transparent;
        border-radius: 15px;
        padding: 12px 16px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    [data-bs-theme="dark"] .form-control,
    [data-bs-theme="dark"] .form-select {
        background: rgba(26, 26, 46, 0.9);
        color: var(--dark-text);
        border-color: rgba(255, 255, 255, 0.1);
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        background: white;
        outline: none;
    }

    .form-control:disabled {
        background: rgba(248, 249, 250, 0.6);
        color: #6c757d;
        border-color: rgba(0, 0, 0, 0.1);
        cursor: not-allowed;
    }

    [data-bs-theme="dark"] .form-control:disabled {
        background: rgba(26, 26, 46, 0.3);
        color: rgba(255, 255, 255, 0.4);
        border-color: rgba(255, 255, 255, 0.05);
    }

    /* Summary Stats Cards */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .summary-stat {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        padding: 2.5rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        cursor: pointer;
    }

    [data-bs-theme="dark"] .summary-stat {
        background: var(--dark-glass-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .summary-stat::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        border-radius: 25px 25px 0 0;
        transition: all 0.3s ease;
    }

    .summary-stat.total::before { background: var(--info); }
    .summary-stat.success::before { background: var(--success); }
    .summary-stat.danger::before { background: var(--danger); }
    .summary-stat.warning::before { background: var(--warning); }

    .summary-stat:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    }

    .summary-stat:hover::before {
        height: 100%;
        opacity: 0.1;
    }

    .summary-icon {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        margin: 0 auto 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .summary-icon.total { background: var(--info); }
    .summary-icon.success { background: var(--success); }
    .summary-icon.danger { background: var(--danger); }
    .summary-icon.warning { background: var(--warning); }

    .summary-number {
        font-size: 4rem;
        font-weight: 800;
        margin: 1rem 0;
        font-family: 'JetBrains Mono', monospace;
    }

    .summary-label {
        font-size: 1.2rem;
        font-weight: 600;
        opacity: 0.8;
    }

    /* Violation Cards */
    .violations-section {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    [data-bs-theme="dark"] .violations-section {
        background: var(--dark-glass-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .violations-header {
        background: var(--warning);
        color: white;
        padding: 1.5rem 2rem;
        font-weight: 600;
    }

    .violations-body {
        padding: 2rem;
    }

    .violation-item {
        background: rgba(255, 193, 7, 0.1);
        border: 2px solid rgba(255, 193, 7, 0.2);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .violation-item:hover {
        transform: translateY(-5px);
        border-color: rgba(255, 193, 7, 0.4);
        box-shadow: 0 15px 30px rgba(255, 193, 7, 0.2);
    }

    .violation-number {
        font-size: 3rem;
        font-weight: 800;
        margin: 1rem 0;
        font-family: 'JetBrains Mono', monospace;
        color: #ff6b35;
    }

    /* Enhanced Table */
    .data-table-section {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    [data-bs-theme="dark"] .data-table-section {
        background: var(--dark-glass-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .table-header {
        background: var(--primary);
        color: white;
        padding: 1.5rem 2rem;
        font-weight: 600;
    }

    .table-responsive {
        border-radius: 0 0 25px 25px;
        overflow: hidden;
    }

    .table {
        margin-bottom: 0;
        background: transparent;
    }

    .table th {
        background: rgba(102, 126, 234, 0.1);
        border: none;
        font-weight: 600;
        padding: 1.5rem 1rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table td {
        border: none;
        padding: 1.5rem 1rem;
        vertical-align: middle;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
    }

    [data-bs-theme="dark"] .table td {
        background: rgba(26, 26, 46, 0.5);
        color: var(--dark-text);
    }

    .table tbody tr {
        transition: all 0.3s ease;
    }

    .table tbody tr:hover {
        transform: scale(1.01);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .badge {
        border-radius: 15px;
        padding: 8px 16px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .progress {
        height: 25px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.2);
        overflow: hidden;
    }

    .progress-bar {
        border-radius: 15px;
        transition: width 1s ease;
        position: relative;
        overflow: hidden;
    }

    .progress-bar::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: progressShine 2s infinite;
    }

    @keyframes progressShine {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    /* Enhanced Charts */
    .chart-container {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    [data-bs-theme="dark"] .chart-container {
        background: var(--dark-glass-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chart-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }

    .chart-title {
        background: var(--primary);
        color: white;
        padding: 1.5rem 2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .chart-body {
        padding: 2rem;
        height: 450px;
    }

    /* Loading States */
    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 15px;
        height: 40px;
        margin-bottom: 1rem;
    }

    [data-bs-theme="dark"] .loading-skeleton {
        background: linear-gradient(90deg, #2a2a3e 25%, #1a1a2e 50%, #2a2a3e 75%);
        background-size: 200% 100%;
    }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* No Data State */
    .no-data {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
    }

    .no-data-icon {
        font-size: 5rem;
        margin-bottom: 2rem;
        opacity: 0.3;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .summary-grid {
            grid-template-columns: 1fr;
        }
        
        .summary-number {
            font-size: 3rem;
        }
        
        .table-responsive {
            font-size: 0.9rem;
        }
    }

    /* Стили для кастомного select */
    .custom-select {
        background: rgba(255, 255, 255, 0.9) !important;
        border: 2px solid transparent !important;
        border-radius: 15px !important;
        padding: 12px 16px !important;
        font-weight: 500 !important;
        height: 48px !important;
        appearance: none !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23667eea' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e") !important;
        background-repeat: no-repeat !important;
        background-position: right 12px center !important;
        background-size: 16px 12px !important;
        cursor: pointer !important;
    }

    [data-bs-theme="dark"] .custom-select {
        background: rgba(26, 26, 46, 0.9) !important;
        color: var(--dark-text) !important;
        border-color: rgba(255, 255, 255, 0.1) !important;
    }

    .custom-select:focus {
        border-color: #667eea !important;
        outline: none !important;
        box-shadow: none !important;
    }

    .custom-select option {
        background: white !important;
        color: #333 !important;
        padding: 10px !important;
    }

    [data-bs-theme="dark"] .custom-select option {
        background: rgba(26, 26, 46, 0.9) !important;
        color: var(--dark-text) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Analytics Hero -->
    <div class="analytics-hero animate-fade-in">
        <div class="hero-content">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="hero-title">
                        <i class="fas fa-chart-line me-3"></i>Центр аналитики
                    </h1>
                    <p class="hero-subtitle">
                        Глубокий анализ производительности и детальная статистика команды
                    </p>
                </div>
                <div class="col-lg-4 text-end">
                    <div class="status-indicator status-online">
                        <div class="spinner-grow spinner-grow-sm" role="status"></div>
                        Данные в реальном времени
                    </div>
                    <p class="mt-3 mb-0 small">
                        <i class="fas fa-clock me-2"></i>
                        <span id="current-time"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Period Control -->
    <div class="period-control" style="animation-delay: 0.2s">
        <div class="row align-items-end">
            <div class="col-lg-3">
                <label class="form-label fw-bold">
                    <i class="fas fa-calendar-alt me-2"></i>Тип анализа
                </label>
                <select class="form-select custom-select" id="periodSelect" onchange="handlePeriodChange()">
                    <option value="daily">Ежедневная аналитика</option>
                    <option value="weekly">Еженедельная аналитика</option>
                    <option value="monthly" selected>Месячная аналитика</option>
                </select>
            </div>
            <div class="col-lg-2">
                <label class="form-label fw-bold">
                    <i class="fas fa-play me-2"></i>Начальная дата
                </label>
                <input type="date" class="form-control" id="startDate" disabled readonly>
            </div>
            <div class="col-lg-2">
                <label class="form-label fw-bold">
                    <i class="fas fa-stop me-2"></i>Конечная дата
                </label>
                <input type="date" class="form-control" id="endDate" disabled readonly>
            </div>
            <div class="col-lg-2">
                <button class="btn btn-gradient-primary w-100" onclick="loadStatistics()">
                    <i class="fas fa-analytics me-2"></i>Проанализировать
                </button>
            </div>
            <div class="col-lg-3">
                <label class="form-label fw-bold">
                    <i class="fas fa-table me-2"></i>Экспорт в Google Sheets
                </label>
                <div class="btn-group w-100" role="group">
                    <button class="btn btn-success" onclick="exportToSheets('all')" title="Экспорт статистики всех сотрудников">
                        <i class="fas fa-users me-1"></i>Все
                    </button>
                    {% if not userInfo.is_admin %}
                    <button class="btn btn-info" onclick="exportToSheets('my')" title="Экспорт моей статистики">
                        <i class="fas fa-user me-1"></i>Моя
                    </button>
                    {% endif %}
                    {% if userInfo.is_admin %}
                    <button class="btn btn-warning" onclick="setupAutoExport()" title="Настроить автоматический экспорт">
                        <i class="fas fa-cog me-1"></i>Авто
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-5" style="display: none;">
        <div class="loading-dots">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
        <p class="mt-3 text-muted">Обработка данных...</p>
    </div>

    <!-- Statistics Content -->
    <div id="statisticsContent">
        <!-- Summary Statistics -->
        <div class="summary-grid animate-slide-up" style="animation-delay: 0.4s" id="summarySection">
            <div class="summary-stat total">
                <div class="summary-icon total">
                    <i class="fas fa-envelope text-white"></i>
                </div>
                <div class="summary-number total" id="totalMessages">0</div>
                <div class="summary-label">Всего сообщений</div>
            </div>
            <div class="summary-stat success">
                <div class="summary-icon success">
                    <i class="fas fa-check-circle text-white"></i>
                </div>
                <div class="summary-number success" id="respondedMessages">0</div>
                <div class="summary-label">Успешно обработано</div>
            </div>
            <div class="summary-stat danger">
                <div class="summary-icon danger">
                    <i class="fas fa-times-circle text-white"></i>
                </div>
                <div class="summary-number danger" id="missedMessages">0</div>
                <div class="summary-label">Пропущено</div>
            </div>
            <div class="summary-stat warning">
                <div class="summary-icon warning">
                    <i class="fas fa-percentage text-white"></i>
                </div>
                <div class="summary-number warning"><span id="efficiency">0</span>%</div>
                <div class="summary-label">Эффективность</div>
            </div>
        </div>

        <!-- Violations Section -->
        <div class="violations-section animate-slide-up" style="animation-delay: 0.6s">
            <div class="violations-header">
                <h5 class="mb-0">
                    <i class="fas fa-stopwatch me-2"></i>
                    Анализ превышений времени ответа
                </h5>
            </div>
            <div class="violations-body">
                <div class="row">
                    <div class="col-lg-4 mb-3">
                        <div class="violation-item">
                            <i class="fas fa-hourglass-start fa-3x text-warning mb-3"></i>
                            <div class="violation-number" id="exceeded15">0</div>
                            <div class="fw-bold">Превышение 15 минут</div>
                            <small class="text-muted">Требует внимания</small>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="violation-item">
                            <i class="fas fa-hourglass-half fa-3x text-warning mb-3"></i>
                            <div class="violation-number" id="exceeded30">0</div>
                            <div class="fw-bold">Превышение 30 минут</div>
                            <small class="text-muted">Критическая задержка</small>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="violation-item">
                            <i class="fas fa-hourglass-end fa-3x text-danger mb-3"></i>
                            <div class="violation-number" id="exceeded60">0</div>
                            <div class="fw-bold">Превышение 60 минут</div>
                            <small class="text-muted">Требует немедленных действий</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="data-table-section animate-slide-up" style="animation-delay: 0.8s">
            <div class="table-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Детализированная статистика по сотрудникам
                </h5>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-calendar me-2"></i>Период</th>
                            <th id="employeeColumn"><i class="fas fa-user me-2"></i>Сотрудник</th>
                            <th><i class="fas fa-envelope me-2"></i>Всего</th>
                            <th><i class="fas fa-check me-2"></i>Отвечено</th>
                            <th><i class="fas fa-times me-2"></i>Пропущено</th>
                            <th><i class="fas fa-clock me-2"></i>Ср. время</th>
                            <th><i class="fas fa-exclamation me-2"></i>>15м</th>
                            <th><i class="fas fa-exclamation me-2"></i>>30м</th>
                            <th><i class="fas fa-exclamation me-2"></i>>60м</th>
                            <th><i class="fas fa-chart-line me-2"></i>Результат</th>
                        </tr>
                    </thead>
                    <tbody id="statisticsTableBody">
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <div class="loading-skeleton"></div>
                                <div class="loading-skeleton"></div>
                                <div class="loading-skeleton"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="chart-container animate-slide-up" style="animation-delay: 1s">
                    <div class="chart-title">
                        <i class="fas fa-chart-area"></i>
                        <span>Динамика времени ответа</span>
                    </div>
                    <div class="chart-body">
                        <canvas id="efficiencyChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="chart-container animate-slide-up" style="animation-delay: 1.2s">
                    <div class="chart-title">
                        <i class="fas fa-chart-pie"></i>
                        <span>Распределение результатов</span>
                    </div>
                    <div class="chart-body">
                        <canvas id="responsePieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- No Data State -->
    <div id="noDataState" class="no-data" style="display: none;">
        <div class="no-data-icon">
            <i class="fas fa-chart-bar"></i>
        </div>
        <h3>Данные отсутствуют</h3>
        <p class="text-muted">Попробуйте изменить период анализа или проверьте настройки фильтрации</p>
        <button class="btn btn-gradient-primary" onclick="resetFilters()">
            <i class="fas fa-refresh me-2"></i>Сбросить фильтры
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Получаем данные пользователя из серверного шаблона
    const serverUserData = {
        employee_id: {{ userInfo.employee_id or 0 }},
        telegram_id: {{ userInfo.telegram_id or 0 }},
        full_name: '{{ userInfo.full_name or "Guest" }}',
        is_admin: {% if userInfo.is_admin %}true{% else %}false{% endif %},
        is_active: {% if userInfo.is_active %}true{% else %}false{% endif %}
    };
    
    // Обновляем userInfo из base.html актуальными серверными данными
    Object.assign(userInfo, serverUserData);
    
    console.log('User info updated:', userInfo);

    let statisticsData = [];
    let efficiencyChart = null;
    let responsePieChart = null;

    // Update current time
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('current-time').textContent = `Обновлено в ${timeString}`;
    }

    // Handle period selection change
    function handlePeriodChange() {
        const periodSelect = document.getElementById('periodSelect');
        toggleDateFields();
        console.log(`📅 Period changed to: ${periodSelect.value}`);
    }

    // Toggle date fields based on period selection
    function toggleDateFields() {
        const periodSelect = document.getElementById('periodSelect');
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');
        
        // Устанавливаем даты автоматически в зависимости от выбранного периода
        const today = new Date();
        let startDateValue, endDateValue;
        
        switch(periodSelect.value) {
            case 'daily':
                // Сегодня
                startDateValue = today.toISOString().split('T')[0];
                endDateValue = today.toISOString().split('T')[0];
                break;
            case 'weekly':
                // Последние 7 дней
                const weekAgo = new Date(today);
                weekAgo.setDate(today.getDate() - 7);
                startDateValue = weekAgo.toISOString().split('T')[0];
                endDateValue = today.toISOString().split('T')[0];
                break;
            case 'monthly':
                // Текущий месяц
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                startDateValue = startOfMonth.toISOString().split('T')[0];
                endDateValue = today.toISOString().split('T')[0];
                break;
            default:
                return;
        }
        
        startDate.value = startDateValue;
        endDate.value = endDateValue;
        
        console.log('📅 Period activated:', periodSelect.value, 'with dates:', startDateValue, 'to', endDateValue);
    }

    // Set default dates
    function setDefaultDates() {
        // Устанавливаем месячный период по умолчанию (уже установлен в HTML)
        document.getElementById('periodSelect').value = 'monthly';
        toggleDateFields(); // Это установит правильные даты
    }

    // Animate number counters
    function animateCounter(elementId, targetValue) {
        const element = document.getElementById(elementId);
        const startValue = parseInt(element.textContent) || 0;
        const duration = 1500;
        const startTime = performance.now();
        
        function updateCounter(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            const easeOut = 1 - Math.pow(1 - progress, 3);
            const currentValue = Math.round(startValue + (targetValue - startValue) * easeOut);
            
            element.textContent = currentValue;
            
            if (progress < 1) {
                requestAnimationFrame(updateCounter);
            }
        }
        
        requestAnimationFrame(updateCounter);
    }

    // Load statistics
    async function loadStatistics() {
        console.log('🔄 Starting to load statistics...');
        
        const periodType = document.getElementById('periodSelect').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        console.log('📋 Parameters:');
        console.log('  - periodType:', periodType);
        console.log('  - startDate:', startDate);
        console.log('  - endDate:', endDate);
        console.log('  - userInfo:', userInfo);
        
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('statisticsContent').style.display = 'none';
        document.getElementById('noDataState').style.display = 'none';
        
        try {
            // Load summary data with selected period and dates
            console.log('📊 Loading summary data...');
            await loadSummaryData(periodType, startDate, endDate);
            
            // Build URL for detailed statistics
            let url = `/api/statistics/${userInfo.is_admin ? 'all' : 'my'}?period_type=${periodType}`;
            if (startDate && startDate.trim() !== '') {
                url += `&start_date=${startDate}`;
            }
            if (endDate && endDate.trim() !== '') {
                url += `&end_date=${endDate}`;
            }
            
            console.log('📡 Making API request to:', url);
            const response = await axios.get(url);
            statisticsData = response.data;
            
            console.log('✅ API response received:');
            console.log('  - status:', response.status);
            console.log('  - data length:', statisticsData ? statisticsData.length : 'null');
            console.log('  - data sample:', statisticsData ? statisticsData.slice(0, 2) : 'null');
            
            if (!statisticsData || statisticsData.length === 0) {
                console.log('⚠️ No data received, showing no data state');
                showNoDataState();
                return;
            }
            
            console.log('🔄 Rendering table and charts...');
            renderStatisticsTable();
            renderCharts();
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('statisticsContent').style.display = 'block';
            
            console.log('✅ Statistics loaded successfully');
            
        } catch (error) {
            console.error('❌ Error loading statistics:', error);
            console.error('Error details:', error.response?.data || error.message);
            console.error('Error status:', error.response?.status);
            
            if (error.response?.status === 400) {
                showNotification('error', 'Ошибка запроса', error.response.data?.error || 'Неверные параметры запроса');
            } else if (error.response?.status === 404) {
                showNotification('info', 'Данные не найдены', 'За указанный период данные отсутствуют');
            } else {
                showNotification('error', 'Ошибка загрузки', 'Произошла ошибка при загрузке статистики');
            }
            
            document.getElementById('loadingState').style.display = 'none';
            showNoDataState();
        }
    }

    // Load summary data with selected parameters
    async function loadSummaryData(periodType = 'daily', startDate = null, endDate = null) {
        try {
            // Build summary URL with parameters
            let summaryUrl = '/api/statistics/summary';
            const params = new URLSearchParams();
            
            // Determine period based on date range if provided
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays <= 1) {
                    params.append('period', 'today');
                } else if (diffDays <= 7) {
                    params.append('period', 'week');
                } else {
                    params.append('period', 'month');
                }
                
                params.append('start_date', startDate);
                params.append('end_date', endDate);
            } else {
                // Default period
                params.append('period', 'month');
            }
            
            if (params.toString()) {
                summaryUrl += '?' + params.toString();
            }
            
            console.log('Loading summary with URL:', summaryUrl);
            
            const summaryResponse = await axios.get(summaryUrl);
            const summary = summaryResponse.data;
            
            console.log('Summary data received:', summary);
            
            // Animate counters
            setTimeout(() => animateCounter('totalMessages', summary.total_messages || 0), 100);
            setTimeout(() => animateCounter('respondedMessages', summary.responded_messages || 0), 200);
            setTimeout(() => animateCounter('missedMessages', summary.missed_messages || 0), 300);
            setTimeout(() => animateCounter('efficiency', summary.efficiency_percent || 0), 400);
            setTimeout(() => animateCounter('exceeded15', summary.exceeded_15_min || 0), 500);
            setTimeout(() => animateCounter('exceeded30', summary.exceeded_30_min || 0), 600);
            setTimeout(() => animateCounter('exceeded60', summary.exceeded_60_min || 0), 700);
            
        } catch (error) {
            console.error('Error loading summary:', error);
            // Set fallback values
            animateCounter('totalMessages', 0);
            animateCounter('respondedMessages', 0);
            animateCounter('missedMessages', 0);
            animateCounter('efficiency', 0);
            animateCounter('exceeded15', 0);
            animateCounter('exceeded30', 0);
            animateCounter('exceeded60', 0);
        }
    }

    // Render statistics table
    function renderStatisticsTable() {
        const tbody = document.getElementById('statisticsTableBody');
        
        if (!userInfo.is_admin) {
            document.getElementById('employeeColumn').style.display = 'none';
        }
        
        if (statisticsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-5">Нет данных за выбранный период</td></tr>';
            return;
        }
        
        tbody.innerHTML = statisticsData.map((stat, index) => `
            <tr style="animation-delay: ${index * 0.1}s" class="animate-slide-up">
                <td>
                    <span class="badge bg-secondary">
                        ${new Date(stat.date).toLocaleDateString('ru-RU')}
                    </span>
                </td>
                ${userInfo.is_admin ? `<td><strong>${stat.employee_name}</strong></td>` : ''}
                <td><span class="badge bg-info fs-6">${stat.total_messages}</span></td>
                <td><span class="badge bg-success fs-6">${stat.responded_messages}</span></td>
                <td><span class="badge bg-danger fs-6">${stat.missed_messages}</span></td>
                <td>
                    <span class="badge ${getTimeClass(stat.avg_response_time)} fs-6">
                        ${stat.avg_response_time ? Math.round(stat.avg_response_time) : 0}м
                    </span>
                </td>
                <td><span class="badge bg-warning text-dark fs-6">${stat.exceeded_15_min}</span></td>
                <td><span class="badge bg-warning text-dark fs-6">${stat.exceeded_30_min}</span></td>
                <td><span class="badge bg-danger fs-6">${stat.exceeded_60_min}</span></td>
                <td>
                    <div class="progress">
                        <div class="progress-bar ${getEfficiencyClass(stat.efficiency_percent)}" 
                             style="width: ${stat.efficiency_percent || 0}%">
                            ${stat.efficiency_percent ? Math.round(stat.efficiency_percent) : 0}%
                        </div>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Get efficiency class
    function getEfficiencyClass(efficiency) {
        if (!efficiency) return 'bg-secondary';
        if (efficiency >= 90) return 'bg-success';
        if (efficiency >= 75) return 'bg-info';
        if (efficiency >= 60) return 'bg-warning';
        return 'bg-danger';
    }

    // Get time class
    function getTimeClass(time) {
        if (!time) return 'bg-secondary';
        if (time <= 15) return 'bg-success';
        if (time <= 30) return 'bg-warning text-dark';
        return 'bg-danger';
    }

    // Render charts
    function renderCharts() {
        renderEfficiencyChart();
        renderResponsePieChart();
    }

    // Efficiency chart
    function renderEfficiencyChart() {
        console.log('📊 Rendering efficiency chart...');
        console.log('📊 statisticsData:', statisticsData);
        
        const ctx = document.getElementById('efficiencyChart').getContext('2d');
        
        if (efficiencyChart) {
            efficiencyChart.destroy();
        }
        
        if (!statisticsData || statisticsData.length === 0) {
            console.log('⚠️ No statistics data available for chart, showing empty chart');
            
            // Создаем пустой график с заглушкой
            efficiencyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Нет данных'],
                    datasets: [{
                        label: 'Среднее время ответа (мин)',
                        data: [0],
                        borderColor: '#ff9f40',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 120,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) { return value + ' мин'; }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                        }
                    },
                    animation: { duration: 0 }
                }
            });
            return;
        }
        
        const chartData = {};
        statisticsData.forEach((stat, index) => {
            console.log(`📊 Processing stat ${index}:`, stat);
            
            // Проверяем, что есть реальные данные для этой записи
            if (stat.total_messages > 0 && stat.avg_response_time && stat.avg_response_time > 0) {
                const date = new Date(stat.date).toLocaleDateString('ru-RU');
                if (!chartData[date]) {
                    chartData[date] = { totalTime: 0, count: 0, totalMessages: 0 };
                }
                chartData[date].totalTime += stat.avg_response_time;
                chartData[date].count += 1;
                chartData[date].totalMessages += stat.total_messages;
                
                console.log(`📊 Added data for ${date}: time=${stat.avg_response_time}, total=${stat.total_messages}`);
            } else {
                console.log(`📊 Skipped stat ${index} - no valid data (messages: ${stat.total_messages}, time: ${stat.avg_response_time})`);
            }
        });
        
        console.log('📊 Processed chart data:', chartData);
        
        // Берем только даты с реальными данными
        const labels = Object.keys(chartData).slice(-14);
        const responseTimeData = labels.map(date => {
            const data = chartData[date];
            return data.count > 0 ? Math.round(data.totalTime / data.count) : 0;
        });
        
        console.log('📊 Final chart data:');
        console.log('  - labels:', labels);
        console.log('  - responseTimeData:', responseTimeData);
        
        // Если нет данных вообще, показываем пустой график
        if (labels.length === 0 || responseTimeData.every(val => val === 0)) {
            console.log('⚠️ No valid data for chart, showing empty state');
            
            efficiencyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Нет данных'],
                    datasets: [{
                        label: 'Среднее время ответа (мин)',
                        data: [0],
                        borderColor: '#ff9f40',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 120,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) { return value + ' мин'; }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                        }
                    },
                    animation: { duration: 0 }
                }
            });
            return;
        }
        
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(255, 159, 64, 0.4)');
        gradient.addColorStop(1, 'rgba(255, 159, 64, 0.05)');
        
        console.log('📊 Creating response time chart with Chart.js...');
        efficiencyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Среднее время ответа (мин)',
                    data: responseTimeData,
                    borderColor: '#ff9f40',
                    backgroundColor: gradient,
                    tension: 0.4,
                    borderWidth: 4,
                    pointBackgroundColor: '#ff6384',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 3,
                    pointRadius: 8,
                    pointHoverRadius: 12,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#ff9f40',
                        borderWidth: 2,
                        cornerRadius: 15,
                        callbacks: {
                            label: function(context) {
                                return `Время ответа: ${context.parsed.y} мин`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 120,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            callback: function(value) { return value + ' мин'; }
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeOutQuart'
                }
            }
        });
        
        console.log('✅ Efficiency chart created successfully');
    }

    // Response pie chart
    function renderResponsePieChart() {
        console.log('📊 Rendering response pie chart...');
        console.log('📊 statisticsData for pie chart:', statisticsData);
        
        const ctx = document.getElementById('responsePieChart').getContext('2d');
        
        if (responsePieChart) {
            responsePieChart.destroy();
        }
        
        if (!statisticsData || statisticsData.length === 0) {
            console.log('⚠️ No statistics data available for pie chart');
            return;
        }
        
        const totalResponded = statisticsData.reduce((sum, stat) => sum + stat.responded_messages, 0);
        const totalMissed = statisticsData.reduce((sum, stat) => sum + stat.missed_messages, 0);
        const totalMessages = statisticsData.reduce((sum, stat) => sum + stat.total_messages, 0);
        const totalPending = totalMessages - totalResponded - totalMissed;
        
        console.log('📊 Pie chart calculations:');
        console.log('  - totalResponded:', totalResponded);
        console.log('  - totalMissed:', totalMissed);
        console.log('  - totalMessages:', totalMessages);
        console.log('  - totalPending:', totalPending);
        
        console.log('📊 Creating pie chart with Chart.js...');
        responsePieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Отвечено', 'Пропущено', 'В обработке'],
                datasets: [{
                    data: [totalResponded, totalMissed, Math.max(0, totalPending)],
                    backgroundColor: ['#4facfe', '#ff6b9d', '#feca57'],
                    borderWidth: 0,
                    hoverBorderWidth: 4,
                    hoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'rgba(255, 255, 255, 0.8)',
                            padding: 25,
                            usePointStyle: true,
                            font: { size: 14, weight: 600 }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeOutBounce'
                }
            }
        });
        
        console.log('✅ Pie chart created successfully');
    }

    // Show no data state
    function showNoDataState() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('statisticsContent').style.display = 'none';
        document.getElementById('noDataState').style.display = 'block';
    }

    // Reset filters
    function resetFilters() {
        document.getElementById('periodSelect').value = 'daily';
        toggleDateFields();
        setDefaultDates();
        loadStatistics();
    }

    // Export to Google Sheets
    async function exportToSheets(type) {
        const periodType = document.getElementById('periodSelect').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        // Показываем индикатор загрузки
        const btn = event.target.closest('button');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Экспорт...';
        btn.disabled = true;
        
        try {
            // Определяем период для API
            let period = 'today';
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays <= 1) period = 'today';
                else if (diffDays <= 7) period = 'week';
                else period = 'month';
            } else if (periodType === 'weekly') {
                period = 'week';
            } else if (periodType === 'monthly') {
                period = 'month';
            }
            
            // Параметры запроса
            const params = new URLSearchParams({ period });
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            
            // Определяем employee_id для персонального экспорта
            if (type === 'my' && !userInfo.is_admin) {
                params.append('employee_id', userInfo.employee_id);
            } else if (type === 'all' && userInfo.is_admin) {
                // Для всех сотрудников employee_id не указываем
            }
            
            console.log('Export request params:', params.toString());
            console.log('Export type:', type);
            console.log('User info:', userInfo);
            
            // Выполняем запрос
            const response = await axios.post(`/api/statistics/export-to-sheets?${params.toString()}`);
            
            if (response.data.success) {
                // Показываем уведомление об успехе
                showNotification('success', 'Экспорт завершен!', 
                    `${response.data.message}<br>
                     <a href="${response.data.url}" target="_blank" class="btn btn-sm btn-light mt-2">
                         <i class="fas fa-external-link-alt me-1"></i>Открыть таблицу
                     </a>`
                );
            } else {
                throw new Error(response.data.error || 'Ошибка экспорта');
            }
            
        } catch (error) {
            console.error('Export error:', error);
            console.error('Error response:', error.response);
            
            let errorMessage = 'Ошибка при экспорте данных';
            let helpMessage = '';
            
            if (error.response) {
                // Сервер ответил с ошибкой
                console.error('Server error data:', error.response.data);
                console.error('Status:', error.response.status);
                
                if (error.response.data) {
                    if (typeof error.response.data === 'string') {
                        errorMessage = error.response.data;
                    } else if (error.response.data.error) {
                        errorMessage = error.response.data.error;
                        if (error.response.data.help) {
                            helpMessage = error.response.data.help;
                        }
                        if (error.response.data.details) {
                            console.error('Error details:', error.response.data.details);
                            helpMessage += helpMessage ? '\n\n' : '';
                            helpMessage += 'Детали: ' + JSON.stringify(error.response.data.details, null, 2);
                        }
                    } else {
                        errorMessage = JSON.stringify(error.response.data, null, 2);
                    }
                }
                
                // Специальные сообщения для разных статусов
                if (error.response.status === 400) {
                    if (errorMessage.includes('Google Sheets интеграция отключена')) {
                        helpMessage = 'Необходимо настроить Google Sheets интеграцию:\n' +
                                    '1. Создать credentials.json\n' +
                                    '2. Дать доступ service account к таблице\n' +
                                    '3. Проверить настройки в .env файле';
                    }
                } else if (error.response.status === 401) {
                    errorMessage = 'Ошибка авторизации. Необходимо войти в систему заново.';
                } else if (error.response.status === 403) {
                    errorMessage = 'Недостаточно прав для выполнения операции.';
                } else if (error.response.status === 500) {
                    errorMessage = 'Внутренняя ошибка сервера. Проверьте логи.';
                }
            } else if (error.request) {
                // Запрос был отправлен, но ответа не получено
                errorMessage = 'Сервер не отвечает. Проверьте подключение.';
            }
            
            // Формируем полное сообщение об ошибке
            let fullMessage = errorMessage;
            if (helpMessage) {
                fullMessage += '<br><br><small><strong>Помощь:</strong><br>' + 
                              helpMessage.replace(/\n/g, '<br>') + '</small>';
            }
            
            showNotification('error', 'Ошибка экспорта', fullMessage);
        } finally {
            // Восстанавливаем кнопку
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    // Setup auto export modal
    function setupAutoExport() {
        if (!userInfo.is_admin) {
            showNotification('warning', 'Доступ запрещен', 'Только администраторы могут настраивать автоэкспорт');
            return;
        }
        
        // Создаем модальное окно
        const modalHtml = `
            <div class="modal fade" id="autoExportModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-cog me-2"></i>Настройка автоэкспорта
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Автоматический экспорт</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoExportEnabled">
                                    <label class="form-check-label" for="autoExportEnabled">
                                        Включить автоматический экспорт
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="exportSchedule" class="form-label">Расписание</label>
                                <select class="form-select" id="exportSchedule">
                                    <option value="daily">Ежедневно (в 23:59)</option>
                                    <option value="weekly">Еженедельно (воскресенье)</option>
                                    <option value="monthly">Ежемесячно (последний день)</option>
                                </select>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Информация:</strong> Автоэкспорт будет создавать отдельный лист в вашей Google таблице с актуальной статистикой.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="button" class="btn btn-primary" onclick="saveAutoExportSettings()">
                                <i class="fas fa-save me-2"></i>Сохранить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Удаляем старый модал если есть
        const existingModal = document.getElementById('autoExportModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Добавляем новый модал
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Показываем модал
        const modal = new bootstrap.Modal(document.getElementById('autoExportModal'));
        modal.show();
    }

    // Save auto export settings
    async function saveAutoExportSettings() {
        const enabled = document.getElementById('autoExportEnabled').checked;
        const schedule = document.getElementById('exportSchedule').value;
        
        try {
            const response = await axios.post('/api/statistics/auto-export', {
                enabled: enabled,
                schedule: schedule
            });
            
            if (response.data.success) {
                showNotification('success', 'Настройки сохранены', response.data.message);
                
                // Закрываем модал
                const modal = bootstrap.Modal.getInstance(document.getElementById('autoExportModal'));
                modal.hide();
            } else {
                throw new Error(response.data.error || 'Ошибка сохранения');
            }
            
        } catch (error) {
            console.error('Auto export settings error:', error);
            showNotification('error', 'Ошибка', 'Не удалось сохранить настройки автоэкспорта');
        }
    }

    // Show notification
    function showNotification(type, title, message) {
        // Удаляем старые уведомления
        const existingToasts = document.querySelectorAll('.toast');
        existingToasts.forEach(toast => toast.remove());
        
        // Создаем контейнер для уведомлений если его нет
        if (!document.getElementById('toast-container')) {
            document.body.insertAdjacentHTML('beforeend', `
                <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11"></div>
            `);
        }
        
        // Определяем цвет и иконку
        let bgClass = 'bg-primary';
        let icon = 'fas fa-info-circle';
        
        if (type === 'success') {
            bgClass = 'bg-success';
            icon = 'fas fa-check-circle';
        } else if (type === 'error') {
            bgClass = 'bg-danger';
            icon = 'fas fa-exclamation-circle';
        } else if (type === 'warning') {
            bgClass = 'bg-warning';
            icon = 'fas fa-exclamation-triangle';
        }
        
        // HTML уведомления
        const toastHtml = `
            <div class="toast ${bgClass} text-white border-0" role="alert">
                <div class="toast-header ${bgClass} text-white border-0">
                    <i class="${icon} me-2"></i>
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        // Добавляем уведомление
        document.getElementById('toast-container').insertAdjacentHTML('beforeend', toastHtml);
        
        // Показываем уведомление
        const toastElement = document.querySelector('.toast:last-child');
        const toast = new bootstrap.Toast(toastElement, { 
            autohide: type !== 'error', // Ошибки не скрываются автоматически
            delay: 5000 
        });
        toast.show();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        setDefaultDates();
        
        // Load initial statistics with default values
        setTimeout(() => {
            loadStatistics();
        }, 100);
    });
</script>
{% endblock %} 