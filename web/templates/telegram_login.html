<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 450px;
            width: 100%;
            text-align: center;
        }
        .login-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        .form-control {
            font-size: 16px;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
        }
        .auth-step {
            display: none;
        }
        .auth-step.active {
            display: block;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .step-item {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        .step-number {
            background: #e9ecef;
            color: #6c757d;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
        }
        .step-number.active {
            background: #667eea;
            color: white;
        }
        .step-number.completed {
            background: #28a745;
            color: white;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .code-input {
            font-family: 'Courier New', monospace;
            font-size: 24px;
            text-align: center;
            letter-spacing: 5px;
        }
    </style>
</head>
<body>
    <div class="login-card">
        <div class="login-icon">üîê</div>
        <h2 class="mb-3">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∞–≥–æ–≤ -->
        <div class="step-indicator">
            <div class="step-item">
                <div class="step-number active" id="step-1">1</div>
                <span>ID</span>
            </div>
            <div class="step-item">
                <div class="step-number" id="step-2">2</div>
                <span>–ö–æ–¥</span>
            </div>
            <div class="step-item">
                <div class="step-number" id="step-3">3</div>
                <span>–í—Ö–æ–¥</span>
            </div>
        </div>
        
        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>
        
        <!-- –®–∞–≥ 1: –í–≤–æ–¥ ID -->
        <div id="step-id" class="auth-step active">
            <p class="text-muted mb-4">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID</p>
            
            <form onsubmit="sendCode(event)" class="mb-4">
                <div class="mb-3">
                    <label for="telegram-id" class="form-label text-start d-block">
                        <i class="fas fa-id-card me-2"></i>–í–∞—à Telegram ID:
                    </label>
                    <input type="number" class="form-control" id="telegram-id" required 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID">
                </div>
                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="fas fa-paper-plane me-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
                </button>
            </form>
            
            <div class="info-message">
                <h6><i class="fas fa-lightbulb me-2"></i>–ö–∞–∫ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π ID:</h6>
                <p class="mb-0">–ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É <strong>@userinfobot</strong> –∫–æ–º–∞–Ω–¥—É <strong>/start</strong></p>
            </div>
        </div>
        
        <!-- –®–∞–≥ 2: –í–≤–æ–¥ –∫–æ–¥–∞ -->
        <div id="step-code" class="auth-step">
            <p class="text-muted mb-4">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram</p>
            
            <div class="info-message mb-4">
                <i class="fas fa-mobile-alt me-2"></i>
                –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –≤–∞—à Telegram.<br>
                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞.
            </div>
            
            <form onsubmit="verifyCode(event)" class="mb-4">
                <div class="mb-3">
                    <label for="verification-code" class="form-label text-start d-block">
                        <i class="fas fa-key me-2"></i>–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
                    </label>
                    <input type="text" class="form-control code-input" id="verification-code" required 
                           placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                </div>
                <button type="submit" class="btn btn-primary btn-lg w-100 mb-2">
                    <i class="fas fa-sign-in-alt me-2"></i>–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
                </button>
                <button type="button" class="btn btn-secondary w-100" onclick="goBackToStep1()">
                    <i class="fas fa-arrow-left me-2"></i>–ò–∑–º–µ–Ω–∏—Ç—å ID
                </button>
            </form>
            
            <p class="text-muted small">
                –ö–æ–¥ –¥–µ–π—Å—Ç–≤—É–µ—Ç 5 –º–∏–Ω—É—Ç.<br>
                –ù–µ –ø–æ–ª—É—á–∏–ª–∏ –∫–æ–¥? –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.
            </p>
        </div>
        
        <hr class="my-4">
        
        <div class="text-muted small">
            <p><i class="fas fa-shield-alt me-1"></i>–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</p>
            <p>üíº <strong>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:</strong> –ª–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
            <p>üëë <strong>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã:</strong> –ø–æ–ª–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentTelegramId = null;
        
        // –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
        function sendCode(event) {
            event.preventDefault();
            
            const telegramId = document.getElementById('telegram-id').value;
            if (!telegramId) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID', 'error');
                return;
            }
            
            currentTelegramId = telegramId;
            showMessage('–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞...', 'success');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–æ–¥–∞
            fetch('/send-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                    telegram_id: parseInt(telegramId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!', 'success');
                    setTimeout(() => {
                        goToStep2();
                    }, 1500);
                } else {
                    showMessage(data.message || data.error, 'error');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
            });
        }
        
        // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
        function verifyCode(event) {
            event.preventDefault();
            
            const code = document.getElementById('verification-code').value;
            if (!code || code.length !== 6) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥', 'error');
                return;
            }
            
            showMessage('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...', 'success');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–¥–∞
            fetch('/verify-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                    telegram_id: parseInt(currentTelegramId),
                    code: code
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStepIndicator(3);
                    showMessage('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...', 'success');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ localStorage
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è localStorage (–Ω–∞—Å—Ç–æ—è—â–∏–π –≤ cookies)
                    localStorage.setItem('access_token', 'cookie_based_auth');
                    localStorage.setItem('user_info', JSON.stringify(data.user));
                    
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å redirect
                    setTimeout(() => {
                        window.location.replace(data.redirect);
                    }, 1000);
                } else {
                    showMessage(data.message || data.error, 'error');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
            });
        }
        
        // –ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
        function goToStep2() {
            document.getElementById('step-id').classList.remove('active');
            document.getElementById('step-code').classList.add('active');
            updateStepIndicator(2);
            document.getElementById('verification-code').focus();
        }
        
        function goBackToStep1() {
            document.getElementById('step-code').classList.remove('active');
            document.getElementById('step-id').classList.add('active');
            updateStepIndicator(1);
            document.getElementById('telegram-id').focus();
        }
        
        function updateStepIndicator(activeStep) {
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                stepEl.classList.remove('active', 'completed');
                
                if (i < activeStep) {
                    stepEl.classList.add('completed');
                } else if (i === activeStep) {
                    stepEl.classList.add('active');
                }
            }
        }
        
        function showMessage(text, type) {
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (type === 'error') {
                errorDiv.textContent = text;
                errorDiv.style.display = 'block';
            } else {
                successDiv.textContent = text;
                successDiv.style.display = 'block';
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
        document.getElementById('verification-code').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
            if (value.length > 6) value = value.slice(0, 6);
            e.target.value = value;
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ URL
        const urlParams = new URLSearchParams(window.location.search);
        const message = urlParams.get('message');
        const error = urlParams.get('error');
        
        if (error) {
            showMessage(decodeURIComponent(error), 'error');
        } else if (message) {
            showMessage(decodeURIComponent(message), 'success');
        }
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.getElementById('telegram-id').focus();
    </script>
</body>
</html> 