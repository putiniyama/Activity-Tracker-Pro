from fastapi import FastAPI, Depends, HTTPException, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from fastapi.responses import HTMLResponse, RedirectResponse, JSONResponse
from fastapi.exceptions import HTTPException
from pydantic import BaseModel
import uvicorn
import aiohttp
import random
from datetime import datetime, timedelta

from config.config import settings
from database.database import init_db, get_db
from database.models import Employee, Message
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, and_
from .routers import auth, employees, statistics, dashboard
from .routes import settings as settings_router
from .auth import get_current_user, create_access_token
from web.templates import templates

app = FastAPI(title="Employee Activity Tracker", version="1.0.0")

# CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
app.mount("/static", StaticFiles(directory="web/static"), name="static")

# –®–∞–±–ª–æ–Ω—ã
templates = Jinja2Templates(directory="web/templates")

# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ–¥–æ–≤ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
verification_codes = {}

class SendCodeRequest(BaseModel):
    telegram_id: int

class VerifyCodeRequest(BaseModel):
    telegram_id: int
    code: str

@app.post("/send-code")
async def send_verification_code(
    request: SendCodeRequest,
    db: AsyncSession = Depends(get_db)
):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ Telegram"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        result = await db.execute(
            select(Employee).where(Employee.telegram_id == request.telegram_id)
        )
        employee = result.scalar_one_or_none()
        
        if not employee:
            return JSONResponse(
                status_code=400,
                content={"success": False, "error": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"}
            )
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
        code = str(random.randint(100000, 999999))
        expires_at = datetime.utcnow() + timedelta(minutes=5)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥
        verification_codes[request.telegram_id] = {
            "code": code,
            "expires_at": expires_at,
            "attempts": 0
        }
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ —á–µ—Ä–µ–∑ Telegram Bot API
        bot_token = "8110382002:AAHuWex2O-QvW7ElqyOMu1ZHJEGiS8dSGmE"
        message = f"üîê –í–∞—à –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:\n\n<b>{code}</b>\n\n‚è∞ –ö–æ–¥ –¥–µ–π—Å—Ç–≤—É–µ—Ç 5 –º–∏–Ω—É—Ç"
        
        async with aiohttp.ClientSession() as session:
            url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
            data = {
                "chat_id": request.telegram_id,
                "text": message,
                "parse_mode": "HTML"
            }
            async with session.post(url, data=data) as response:
                if response.status == 200:
                    return JSONResponse(content={
                        "success": True, 
                        "message": "–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –≤–∞—à Telegram",
                        "expires_in": 300
                    })
                else:
                    return JSONResponse(
                        status_code=400,
                        content={"success": False, "error": "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"}
                    )
                    
    except Exception as e:
        return JSONResponse(
            status_code=500,
            content={"success": False, "error": f"–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: {str(e)}"}
        )

@app.post("/verify-code")
async def verify_code(
    request: VerifyCodeRequest,
    response: JSONResponse,
    db: AsyncSession = Depends(get_db)
):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–¥–∞
        if request.telegram_id not in verification_codes:
            return JSONResponse(
                status_code=400,
                content={"success": False, "error": "–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫"}
            )
        
        stored_data = verification_codes[request.telegram_id]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        if datetime.utcnow() > stored_data["expires_at"]:
            del verification_codes[request.telegram_id]
            return JSONResponse(
                status_code=400,
                content={"success": False, "error": "–ö–æ–¥ –∏—Å—Ç–µ–∫"}
            )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        if stored_data["attempts"] >= 3:
            del verification_codes[request.telegram_id]
            return JSONResponse(
                status_code=400,
                content={"success": False, "error": "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫"}
            )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
        if request.code != stored_data["code"]:
            stored_data["attempts"] += 1
            return JSONResponse(
                status_code=400,
                content={"success": False, "error": "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥"}
            )
        
        # –ö–æ–¥ –≤–µ—Ä–Ω—ã–π - —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏ —Å–æ–∑–¥–∞–µ–º —Ç–æ–∫–µ–Ω
        del verification_codes[request.telegram_id]
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        result = await db.execute(
            select(Employee).where(Employee.telegram_id == request.telegram_id)
        )
        employee = result.scalar_one_or_none()
        
        if not employee:
            return JSONResponse(
                status_code=400,
                content={"success": False, "error": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"}
            )
        
        # –°–æ–∑–¥–∞–µ–º —Ç–æ–∫–µ–Ω
        access_token = create_access_token(data={
            "sub": str(employee.telegram_id),
            "employee_id": employee.id,
            "telegram_id": employee.telegram_id,
            "telegram_username": employee.telegram_username,
            "full_name": employee.full_name,
            "is_active": employee.is_active,
            "is_admin": employee.is_admin
        })
        
        # –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç —Å —Ç–æ–∫–µ–Ω–æ–º –≤ cookies
        redirect_url = "/admin" if employee.is_admin else "/dashboard"
        
        response = JSONResponse(content={
            "success": True,
            "message": "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ",
            "redirect": redirect_url,
            "user": {
                "employee_id": employee.id,
                "telegram_id": employee.telegram_id,
                "telegram_username": employee.telegram_username,
                "full_name": employee.full_name,
                "is_active": employee.is_active,
                "is_admin": employee.is_admin,
                "created_at": employee.created_at.isoformat() if employee.created_at else None,
                "updated_at": employee.updated_at.isoformat() if employee.updated_at else None
            }
        })
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cookie —Å —Ç–æ–∫–µ–Ω–æ–º
        response.set_cookie(
            key="access_token",
            value=access_token,
            max_age=1800,  # 30 –º–∏–Ω—É—Ç
            httponly=True,
            secure=False,  # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å True
            samesite="lax"
        )
        
        return response
        
    except Exception as e:
        return JSONResponse(
            status_code=500,
            content={"success": False, "error": f"–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: {str(e)}"}
        )

@app.get("/logout")
async def logout():
    """–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"""
    response = RedirectResponse(url="/login", status_code=302)
    response.delete_cookie(key="access_token")
    return response

@app.get("/dashboard", response_class=HTMLResponse)
async def dashboard_page(request: Request, current_user: dict = Depends(get_current_user), db: AsyncSession = Depends(get_db)):
    """–î–∞—à–±–æ—Ä–¥ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    if current_user.get("is_admin"):
        # –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –∞–¥–º–∏–Ω—Å–∫—É—é –ø–∞–Ω–µ–ª—å
        return templates.TemplateResponse("dashboard.html", {
            "request": request,
            "user": current_user
        })
    else:
        # –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤–∏–¥–∏—Ç –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å –µ–≥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        today = datetime.utcnow().date()
        start_of_day = datetime.combine(today, datetime.min.time())
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
        messages_result = await db.execute(
            select(Message).where(
                and_(
                    Message.employee_id == current_user.get('employee_id'),
                    Message.received_at >= start_of_day
                )
            ).order_by(Message.received_at.desc()).limit(10)
        )
        recent_messages = messages_result.scalars().all()
        
        # –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        total_messages = len(recent_messages)
        responded_messages = sum(1 for m in recent_messages if m.responded_at is not None)
        missed_messages = total_messages - responded_messages
        
        response_times = [m.response_time_minutes for m in recent_messages if m.response_time_minutes is not None]
        avg_response_time = sum(response_times) / len(response_times) if response_times else 0
        
        # –ü—Ä–µ–≤—ã—à–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        exceeded_15_min = sum(1 for t in response_times if t > 15)
        exceeded_30_min = sum(1 for t in response_times if t > 30)
        exceeded_60_min = sum(1 for t in response_times if t > 60)
        
        stats = {
            'total_messages': total_messages,
            'responded_messages': responded_messages,
            'missed_messages': missed_messages,
            'avg_response_time': avg_response_time,
            'exceeded_15_min': exceeded_15_min,
            'exceeded_30_min': exceeded_30_min,
            'exceeded_60_min': exceeded_60_min
        }
        
        return templates.TemplateResponse("employee_dashboard.html", {
            "request": request,
            "user": current_user,
            "stats": stats,
            "recent_messages": recent_messages
        })

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤
app.include_router(auth.router, prefix="/api/auth", tags=["auth"])
app.include_router(employees.router, prefix="/api/employees", tags=["employees"])
app.include_router(statistics.router, prefix="/api/statistics", tags=["statistics"])
app.include_router(dashboard.router, prefix="/api/dashboard", tags=["dashboard"])
app.include_router(settings_router.router)  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
@app.exception_handler(HTTPException)
async def auth_exception_handler(request: Request, exc: HTTPException):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ª–æ–≥–∏–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è HTML —Å—Ç—Ä–∞–Ω–∏—Ü"""
    # –î–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å /api/) –≤–æ–∑–≤—Ä–∞—â–∞–µ–º JSON –æ—à–∏–±–∫—É
    if request.url.path.startswith("/api/"):
        return JSONResponse(
            status_code=exc.status_code,
            content={"detail": exc.detail}
        )
    
    # –î–ª—è HTML —Å—Ç—Ä–∞–Ω–∏—Ü –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω –ø—Ä–∏ 401 –æ—à–∏–±–∫–µ
    if exc.status_code == 401 and request.url.path in ["/admin", "/dashboard", "/settings", "/employees", "/statistics"]:
        return RedirectResponse(url="/login?error=" + exc.detail.replace(" ", "%20"), status_code=302)
    
    # –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
    raise exc


@app.on_event("startup")
async def startup_event():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"""
    await init_db()


@app.get("/", response_class=HTMLResponse)
async def root(request: Request):
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ª–æ–≥–∏–Ω"""
    return templates.TemplateResponse("telegram_login.html", {"request": request})


@app.get("/login", response_class=HTMLResponse)
async def login_page(request: Request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram"""
    return templates.TemplateResponse("telegram_login.html", {"request": request})


@app.get("/employees", response_class=HTMLResponse)
async def employees_page(request: Request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏"""
    return templates.TemplateResponse("employees.html", {"request": request})


@app.get("/statistics", response_class=HTMLResponse)
async def statistics_page(request: Request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    return templates.TemplateResponse("statistics.html", {"request": request})


@app.get("/profile", response_class=HTMLResponse)
async def profile_page(request: Request):
    """–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"""
    return templates.TemplateResponse("profile.html", {"request": request})


@app.get("/settings", response_class=HTMLResponse)
async def settings_page(request: Request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–∏—Å—Ç–µ–º—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
    return templates.TemplateResponse("settings.html", {"request": request})


@app.get("/admin", response_class=HTMLResponse)
async def admin_page(request: Request, current_user: dict = Depends(get_current_user)):
    """–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–æ–π"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
    if not current_user.get("is_admin"):
        # –ï—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
        return templates.TemplateResponse("redirect.html", {
            "request": request,
            "redirect_url": "/dashboard",
            "message": "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç..."
        })
    
    return templates.TemplateResponse("dashboard.html", {
        "request": request,
        "user": current_user
    })


# –†–æ—É—Ç–µ—Ä /dashboard –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ employee.router


@app.get("/health")
async def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    return {"status": "ok", "message": "Employee Activity Tracker is running"}


@app.get("/test-auth")
async def test_auth(current_user: dict = Depends(get_current_user)):
    """–¢–µ—Å—Ç–æ–≤—ã–π endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    return {"user": current_user}


if __name__ == "__main__":
    uvicorn.run(
        "web.main:app",
        host=settings.web_host,
        port=settings.web_port,
        reload=True
    ) 