#!/usr/bin/env python3
"""–ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ —Å —É–º–Ω—ã–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º"""

import os
import asyncio
from aiogram import Bot, Dispatcher
from aiogram.types import Message
from aiogram.filters import Command

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏
from bot.notifications import NotificationService
from bot.smart_monitoring import SmartMonitoringService

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
os.environ["BOT_TOKEN"] = "8110382002:AAHuWex2O-QvW7ElqyOMu1ZHJEGiS8dSGmE"
os.environ["ADMIN_CHAT_ID"] = "896737668"

# –°–æ–∑–¥–∞—ë–º –±–æ—Ç–∞
bot = Bot(token=os.environ["BOT_TOKEN"])
dp = Dispatcher()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã
notification_service = NotificationService(bot)
smart_monitoring = SmartMonitoringService(notification_service)

@dp.message(Command("start"))
async def start_command(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start - –¢–û–õ–¨–ö–û –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö"""
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ –≥—Ä—É–ø–ø–∞—Ö
    if message.chat.type != "private":
        return
    
    user_id = message.from_user.id
    web_url = f"http://localhost:8000/login"
    
    text = f"""
üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤!

üÜî –í–∞—à Telegram ID: <code>{user_id}</code>

–î–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É:
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à Telegram ID
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: {web_url}
3. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID –¥–ª—è –≤—Ö–æ–¥–∞

üîß –§—É–Ω–∫—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã:
‚Ä¢ –£–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö
‚Ä¢ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞—Ü–∏–∏ (@username, reply)
‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–¥–µ—Ä–∂–∫–∞—Ö (–≤ –ª–∏—á–∫—É)
‚Ä¢ –í–µ–±-–ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫

‚ùì –ö–æ–º–∞–Ω–¥—ã (—Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö):
/start - –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
/help - –ü–æ–º–æ—â—å
/stats - –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

‚ö†Ô∏è –í –≥—Ä—É–ø–ø–∞—Ö –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–º–µ—Ç–Ω–æ - —Ç–æ–ª—å–∫–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è!

üéØ <b>–£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞:</b>
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç @username - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ–º—É
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º
‚Ä¢ –û—Ç–≤–µ—Ç–æ–º —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ reply –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
"""
    await message.answer(text, parse_mode="HTML")

@dp.message(Command("help"))
async def help_command(message: Message):
    """–ü–æ–º–æ—â—å - –¢–û–õ–¨–ö–û –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö"""
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ –≥—Ä—É–ø–ø–∞—Ö
    if message.chat.type != "private":
        return
        
    await message.answer("""
ü§ñ <b>–°–∏—Å—Ç–µ–º–∞ —É–º–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</b>

<b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (—Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–∫–µ):</b>
/start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
/stats - –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>
‚Ä¢ –í –≥—Ä—É–ø–ø–∞—Ö: –±–æ—Ç –ù–ï–ó–ê–ú–ï–¢–ù–û –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
‚Ä¢ –í –ª–∏—á–∫–µ: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–¥–µ—Ä–∂–∫–∞—Ö
‚Ä¢ –í–µ–±-–ø–∞–Ω–µ–ª—å: –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

<b>–£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:</b>
üéØ <b>–ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç @username:</b> —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —ç—Ç–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
üéØ <b>–ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</b> —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º
üéØ <b>–û—Ç–≤–µ—Ç–æ–º —Å—á–∏—Ç–∞–µ—Ç—Å—è:</b> —Ç–æ–ª—å–∫–æ reply –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞

<b>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</b>
–ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç –≤–∞–º –≤ –ª–∏—á–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤—ã –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É –≤ —Ç–µ—á–µ–Ω–∏–µ:
‚Ä¢ 15 –º–∏–Ω—É—Ç ‚ö†Ô∏è (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
‚Ä¢ 30 –º–∏–Ω—É—Ç üö® (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
‚Ä¢ 60 –º–∏–Ω—É—Ç üî¥ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)

<b>–í–µ–±-–ø–∞–Ω–µ–ª—å:</b>
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞—à Telegram ID –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –≤–µ–±-—Å–∏—Å—Ç–µ–º—É –ø–æ –∞–¥—Ä–µ—Å—É:
http://localhost:8000/login

<b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏:</b>
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –≤–µ–±-–ø–∞–Ω–µ–ª–∏!
""", parse_mode="HTML")

@dp.message(Command("stats"))
async def stats_command(message: Message):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –¢–û–õ–¨–ö–û –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö"""
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ –≥—Ä—É–ø–ø–∞—Ö
    if message.chat.type != "private":
        return
        
    user_id = message.from_user.id
    
    text = f"""
üìä <b>–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>

üÜî Telegram ID: <code>{user_id}</code>
üìÖ –ü–µ—Ä–∏–æ–¥: –°–µ–≥–æ–¥–Ω—è

üì® –°–æ–æ–±—â–µ–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 0
‚úÖ –û—Ç–≤–µ—á–µ–Ω–æ –≤–æ–≤—Ä–µ–º—è: 0
‚ö†Ô∏è –° –∑–∞–¥–µ—Ä–∂–∫–æ–π: 0
‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–æ: 0

‚è± –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 0 –º–∏–Ω

<i>–î–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ–±-–ø–∞–Ω–µ–ª—å:
http://localhost:8000/login</i>

üí° <b>–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ –≤ —Ä–∞–±–æ—á—É—é –≥—Ä—É–ø–ø—É:</b>
1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
2. –î–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—á—Ç–æ–±—ã –≤–∏–¥–µ–ª –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
3. –ë–æ—Ç –±—É–¥–µ—Ç –Ω–µ–∑–∞–º–µ—Ç–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã
4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏–¥—É—Ç —Å—é–¥–∞, –≤ –ª–∏—á–∫—É!

üéØ <b>–£–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:</b>
‚Ä¢ –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç @—É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ reply
‚Ä¢ –£–≤–µ–¥–æ–º–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
‚Ä¢ –£—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç–æ—è—â–∏–µ –æ—Ç–≤–µ—Ç—ã
"""
    await message.answer(text, parse_mode="HTML")

@dp.message()
async def handle_all_messages(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å —É–º–Ω–æ–π –ª–æ–≥–∏–∫–æ–π"""
    
    # –í –õ–ò–ß–ù–´–• —Å–æ–æ–±—â–µ–Ω–∏—è—Ö - –ø–æ–º–æ–≥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    if message.chat.type == "private":
        await message.answer(
            "üëã –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞!\n\n"
            "üí° –ù–µ –∑–∞–±—É–¥—å—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –º–µ–Ω—è –≤ —Ä–∞–±–æ—á–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.\n\n"
            "üéØ <b>–£–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</b> —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∞–¥—Ä–µ—Å–∞—Ü–∏—é –∏ –Ω–∞—Å—Ç–æ—è—â–∏–µ –æ—Ç–≤–µ—Ç—ã!",
            parse_mode="HTML"
        )
        return
    
    # –í –ì–†–£–ü–ü–ê–• - —É–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    if message.chat.type in ["group", "supergroup"]:
        # –ü–µ—Ä–µ–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —É–º–Ω—ã–π —Å–µ—Ä–≤–∏—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        await smart_monitoring.process_message(message)
        return

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("ü§ñ –ó–∞–ø—É—Å–∫ —É–º–Ω–æ–≥–æ Telegram –±–æ—Ç–∞...")
    print("üìã –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:")
    print("   üí¨ –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: –∫–æ–º–∞–Ω–¥—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")
    print("   üë• –ì—Ä—É–ø–ø—ã: —É–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å –∞–¥—Ä–µ—Å–∞—Ü–∏–µ–π")
    print("   üéØ –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞: @username, reply, –æ–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è")
    print(f"üîó –í–µ–±-–ø–∞–Ω–µ–ª—å: http://localhost:8000")
    print("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: –≤ –≤–µ–±-–ø–∞–Ω–µ–ª–∏")
    
    try:
        await dp.start_polling(bot)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
    finally:
        await bot.session.close()

if __name__ == "__main__":
    asyncio.run(main()) 