# Трекер Активности Сотрудников (Activity Tracker Pro)

**Activity Tracker Pro** — это комплексное решение для мониторинга активности сотрудников в Telegram-чатах поддержки клиентов. Система отслеживает время ответа на сообщения клиентов, генерирует статистику по каждому сотруднику и общую по команде, а также уведомляет о пропущенных сообщениях.

## Основные возможности

- **Отслеживание сообщений клиентов**: Бот автоматически фиксирует новые сообщения от клиентов в групповых чатах.
- **Распределение сообщений**: Каждое новое сообщение от клиента назначается всем активным сотрудникам.
- **Мониторинг времени ответа**: Система измеряет время, затраченное сотрудником на ответ.
- **Уведомления о просроченных ответах**: Если сотрудник не отвечает в течение заданного времени (настраиваемые пороги: 15, 30, 60 минут), бот отправляет уведомления.
- **Статистика и аналитика**:
    - **Веб-интерфейс**: Предоставляет подробную статистику по каждому сотруднику и общую статистику команды.
    - **Telegram-бот**: Сотрудники могут запросить свою личную статистику за сегодня командой `/stats`.
- **Управление сотрудниками**: Администраторы могут добавлять, активировать/деактивировать сотрудников через веб-интерфейс.
- **Аутентификация через Telegram**: Безопасный вход в веб-интерфейс с использованием Telegram ID и одноразовых кодов.
- **Гибкая настройка**: Конфигурация через переменные окружения (`.env` файл).

## Структура проекта

```
.
├── bot/                  # Модули Telegram-бота
│   ├── main.py           # Основная логика бота, обработчики сообщений
│   ├── analytics.py      # Сервис для сбора и расчета статистики
│   ├── notifications.py  # Сервис для отправки уведомлений
│   ├── handlers.py       # Регистрация обработчиков команд и сообщений
│   └── ...
├── web/                  # Модули веб-интерфейса (FastAPI)
│   ├── main.py           # Основное приложение FastAPI, эндпоинты страниц
│   ├── auth.py           # Логика аутентификации
│   ├── routers/          # Роутеры для API (сотрудники, статистика, дашборд, аутентификация)
│   ├── services/         # Сервисы для бизнес-логики веб-части (например, StatisticsService)
│   ├── templates/        # HTML-шаблоны (Jinja2)
│   └── static/           # Статические файлы (CSS, JS)
├── database/             # Модули для работы с базой данных
│   ├── database.py       # Настройка подключения к БД, сессии SQLAlchemy
│   └── models.py         # Модели таблиц SQLAlchemy (Employee, Message, Notification, etc.)
├── config/               # Конфигурация
│   └── config.py         # Pydantic-модель для настроек из .env
├── data/                 # Данные (например, SQLite база данных)
│   └── bot.db            # Файл базы данных SQLite (по умолчанию)
├── logs/                 # Лог-файлы
├── certs/                # SSL сертификаты (если используются)
├── .env                  # Файл с переменными окружения (локально, не в репозитории)
├── .env.example          # Пример файла .env
├── run_bot.py            # Скрипт для запуска только бота
├── run_web.py            # Скрипт для запуска только веб-сервера
├── run_local.sh          # Скрипт для локального запуска бота и веб-сервера
├── stop_local.sh         # Скрипт для остановки локально запущенных сервисов
├── requirements.txt      # Список зависимостей Python
└── README.md             # Этот файл
```

## Технологический стек

- **Бэкенд (бот и веб-API)**: Python 3.10+
    - **Telegram Bot**: Aiogram 3.x
    - **Веб-фреймворк**: FastAPI
    - **База данных**: SQLAlchemy (с поддержкой асинхронности), SQLite (по умолчанию), PostgreSQL (рекомендуется для production)
    - **Уведомления/Фоновые задачи**: APScheduler (интегрирован в бота)
    - **Конфигурация**: Pydantic
- **Фронтенд**: HTML, CSS, JavaScript (используются шаблоны Jinja2)

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone <URL_ВАШЕГО_РЕПОЗИТОРИЯ>
cd Activity-Tracker-Pro
```

### 2. Настройка окружения

- Создайте виртуальное окружение и активируйте его:
  ```bash
  python3 -m venv .venv
  source .venv/bin/activate
  ```
- Установите зависимости:
  ```bash
  pip install -r requirements.txt
  ```
- Создайте файл `.env` на основе `.env.example` и заполните необходимые значения:
  ```bash
  cp .env.example .env
  nano .env  # или любым другим текстовым редактором
  ```
  **Ключевые переменные в `.env`:**
    - `BOT_TOKEN`: Токен вашего Telegram-бота.
    - `DATABASE_URL`: URL для подключения к базе данных. По умолчанию `sqlite+aiosqlite:///./data/bot.db`. Для PostgreSQL: `postgresql+asyncpg://user:password@host:port/dbname`.
    - `SECRET_KEY`: Секретный ключ для FastAPI (для подписи JWT токенов). Сгенерируйте случайную строку.
    - `FIRST_ADMIN_ID`: Telegram ID первого администратора системы (будет создан при первом запуске, если админов еще нет).
    - `WEB_HOST`, `WEB_PORT`: Хост и порт для веб-сервера.
    - Настройки порогов для уведомлений (`RESPONSE_TIME_WARNING_1`, `_2`, `_3`).

### 3. Инициализация базы данных

База данных и таблицы создаются автоматически при первом запуске бота или веб-сервера. Скрипт `run_local.sh` также выполняет инициализацию.

### 4. Запуск

Для удобного запуска используйте скрипты:

- **Запустить все (бот и веб-интерфейс):**
  ```bash
  ./run_local.sh
  ```
  Этот скрипт также:
    - Создает необходимые директории (`data/`, `logs/`).
    - Активирует виртуальное окружение.
    - Устанавливает/обновляет зависимости.
    - Инициализирует базу данных (если еще не создана).
    - Добавляет первого администратора из `FIRST_ADMIN_ID` (если еще не добавлен).
    - Запускает бота и веб-интерфейс в фоновом режиме.

- **Остановить все:**
  ```bash
  ./stop_local.sh
  ```

- **Просмотр логов:**
  ```bash
  tail -f logs/bot.log    # Логи бота
  tail -f logs/web.log    # Логи веб-интерфейса
  ```

## Использование

### Telegram Бот

- **Сотрудники**:
    - `/start`: Приветственное сообщение с инструкциями и Telegram ID для входа в веб-панель.
    - `/stats`: Получить личную статистику ответов за сегодня.
- **Администраторы**:
    - Те же команды, что и у сотрудников.
    - Команда `/stats` для админа также показывает общую сводку по всем сотрудникам.
- **Взаимодействие в группах**:
    - Бот отслеживает сообщения от клиентов (не сотрудников).
    - Когда сотрудник отвечает на сообщение клиента (через функцию "Ответить" в Telegram), бот фиксирует ответ.

### Веб-интерфейс

- **Вход**:
    1. Перейдите по адресу вашего веб-сервера (например, `http://localhost:8000` или `https://your.domain.com`).
    2. Нажмите "Войти через Telegram".
    3. Введите свой Telegram ID (бот подскажет его по команде `/start`).
    4. Нажмите "Отправить код".
    5. Бот пришлет вам в личные сообщения 6-значный код.
    6. Введите код на странице входа.
- **Админ-панель (`/admin` или `/dashboard` для админа)**:
    - Просмотр общей статистики.
    - Управление сотрудниками: добавление, редактирование, активация/деактивация.
    - Доступ к странице настроек системы (`/settings`).
    - Просмотр детальной статистики по всем сотрудникам (`/statistics`).
- **Личный кабинет сотрудника (`/dashboard`)**:
    - Просмотр личной статистики.
    - Список последних сообщений.

## Настройка и Кастомизация

- **Переменные окружения (`.env`)**: Основной способ конфигурации.
- **Время уведомлений**: Настраивается через переменные `RESPONSE_TIME_WARNING_1`, `RESPONSE_TIME_WARNING_2`, `RESPONSE_TIME_WARNING_3` в `.env` (в минутах).
- **Google Sheets Экспорт**: (Если включено `GOOGLE_SHEETS_ENABLED=True`)
    - Настройте `google_sheets_credentials_file` (путь к JSON файлу с учетными данными сервисного аккаунта Google Cloud) и `spreadsheet_id` (ID вашей Google Таблицы).
    - Предоставьте сервисному аккаунту права на редактирование вашей таблицы.

## Возможные доработки

- Более гранулированные права доступа.
- Назначение чатов конкретным сотрудникам.
- Расширенная отчетность и фильтры в веб-интерфейсе.
- Интеграция с другими системами (CRM, HelpDesk).

## Контрибьюция

Будем рады вашему вкладу! Пожалуйста, придерживайтесь принятого стиля кодирования и создавайте pull request'ы в ветку `main` или `develop` (если такая используется). 