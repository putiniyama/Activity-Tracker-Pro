# Трекер Активности Сотрудников (Activity Tracker Pro)

**Activity Tracker Pro** — это комплексное решение для мониторинга активности сотрудников в Telegram-чатах поддержки клиентов. Система отслеживает время ответа на сообщения клиентов, генерирует статистику по каждому сотруднику и общую по команде, а также уведомляет о пропущенных сообщениях.

## Основные возможности

- **Отслеживание сообщений клиентов**: Бот автоматически фиксирует новые сообщения от клиентов в групповых чатах.
- **Распределение сообщений**: Каждое новое сообщение от клиента назначается всем активным сотрудникам.
- **Мониторинг времени ответа**: Система измеряет время, затраченное сотрудником на ответ.
- **Уведомления о просроченных ответах**: Если сотрудник не отвечает в течение заданного времени (настраиваемые пороги: 15, 30, 60 минут), бот отправляет уведомления.
- **Статистика и аналитика**:
    - **Веб-интерфейс**: Предоставляет подробную статистику по каждому сотруднику и общую статистику команды.
    - **Telegram-бот**: Сотрудники могут запросить свою личную статистику за сегодня командой `/stats`.
- **Управление сотрудниками**: Администраторы могут добавлять, активировать/деактивировать сотрудников через веб-интерфейс.
- **Аутентификация через Telegram**: Безопасный вход в веб-интерфейс с использованием Telegram ID и одноразовых кодов.
- **Гибкая настройка**: Конфигурация через переменные окружения (`.env` файл).

## Структура проекта

```
.
├── bot/                  # Модули Telegram-бота
│   ├── main.py           # Основная логика бота, обработчики сообщений
│   ├── analytics.py      # Сервис для сбора и расчета статистики
│   ├── notifications.py  # Сервис для отправки уведомлений
│   ├── handlers.py       # Регистрация обработчиков команд и сообщений
│   └── ...
├── web/                  # Модули веб-интерфейса (FastAPI)
│   ├── main.py           # Основное приложение FastAPI, эндпоинты страниц
│   ├── auth.py           # Логика аутентификации
│   ├── routers/          # Роутеры для API (сотрудники, статистика, дашборд, аутентификация)
│   ├── services/         # Сервисы для бизнес-логики веб-части (например, StatisticsService)
│   ├── templates/        # HTML-шаблоны (Jinja2)
│   └── static/           # Статические файлы (CSS, JS)
├── database/             # Модули для работы с базой данных
│   ├── database.py       # Настройка подключения к БД, сессии SQLAlchemy
│   └── models.py         # Модели таблиц SQLAlchemy (Employee, Message, Notification, etc.)
├── config/               # Конфигурация
│   └── config.py         # Pydantic-модель для настроек из .env
├── data/                 # Данные (например, SQLite база данных)
│   └── bot.db            # Файл базы данных SQLite (по умолчанию)
├── logs/                 # Лог-файлы
├── certs/                # SSL сертификаты (если используются)
├── .env                  # Файл с переменными окружения (локально, не в репозитории)
├── .env.example          # Пример файла .env
├── run_bot.py            # Скрипт для запуска только бота
├── run_web.py            # Скрипт для запуска только веб-сервера
├── run_local.sh          # Скрипт для локального запуска бота и веб-сервера
├── stop_local.sh         # Скрипт для остановки локально запущенных сервисов
├── requirements.txt      # Список зависимостей Python
└── README.md             # Этот файл
```

## Технологический стек

- **Бэкенд (бот и веб-API)**: Python 3.10+
    - **Telegram Bot**: Aiogram 3.x
    - **Веб-фреймворк**: FastAPI
    - **База данных**: SQLAlchemy (с поддержкой асинхронности), SQLite (по умолчанию), PostgreSQL (рекомендуется для production)
    - **Уведомления/Фоновые задачи**: APScheduler (интегрирован в бота)
    - **Конфигурация**: Pydantic
- **Фронтенд**: HTML, CSS, JavaScript (используются шаблоны Jinja2)

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone <URL_ВАШЕГО_РЕПОЗИТОРИЯ>
cd Activity-Tracker-Pro
```

### 2. Подготовка сервера (для Ubuntu)

Обновите систему и установите необходимые пакеты:

```bash
sudo apt update
sudo apt install python3-pip
sudo apt install python3.10-venv
```

### 3. Настройка окружения

- Создайте виртуальное окружение и активируйте его:
  ```bash
  python3 -m venv .venv
  source .venv/bin/activate
  ```
- Установите зависимости:
  ```bash
  pip install -r requirements.txt
  ```
- Создайте файл `.env` на основе `.env.example` и заполните необходимые значения:
  ```bash
  cp .env.example .env
  nano .env  # или любым другим текстовым редактором
  ```
  **Ключевые переменные в `.env`:**
    - `BOT_TOKEN`: Токен вашего Telegram-бота.
    - `DATABASE_URL`: URL для подключения к базе данных. По умолчанию `sqlite+aiosqlite:///./data/bot.db`. Для PostgreSQL: `postgresql+asyncpg://user:password@host:port/dbname`.
    - `SECRET_KEY`: Секретный ключ для FastAPI (для подписи JWT токенов). Сгенерируйте случайную строку.
    - `FIRST_ADMIN_ID`: **ВАЖНО!** Telegram ID первого администратора системы (будет создан при первом запуске, если админов еще нет). Чтобы узнать свой Telegram ID, напишите боту `/start` после запуска.
    - `WEB_HOST`, `WEB_PORT`: Хост и порт для веб-сервера.
    - Настройки порогов для уведомлений (`RESPONSE_TIME_WARNING_1`, `_2`, `_3`).

### 4. Инициализация базы данных

База данных и таблицы создаются автоматически при первом запуске бота или веб-сервера. Скрипт `run_local.sh` также выполняет инициализацию.

### 5. Запуск

Для удобного запуска используйте скрипты:

- **Запустить все (бот и веб-интерфейс):**
  ```bash
  ./run_local.sh
  ```
  Этот скрипт также:
    - Создает необходимые директории (`data/`, `logs/`).
    - Активирует виртуальное окружение.
    - Устанавливает/обновляет зависимости.
    - Инициализирует базу данных (если еще не создана).
    - Добавляет первого администратора из `FIRST_ADMIN_ID` (если еще не добавлен).
    - Запускает бота и веб-интерфейс в фоновом режиме.

- **Остановить все:**
  ```bash
  ./stop_local.sh
  ```

- **Просмотр логов:**
  ```bash
  tail -f logs/bot.log    # Логи бота
  tail -f logs/web.log    # Логи веб-интерфейса
  ```

## Использование

### Telegram Бот

- **Сотрудники**:
    - `/start`: Приветственное сообщение с инструкциями и Telegram ID для входа в веб-панель.
    - `/stats`: Получить личную статистику ответов за сегодня.
- **Администраторы**:
    - Те же команды, что и у сотрудников.
    - Команда `/stats` для админа также показывает общую сводку по всем сотрудникам.
- **Взаимодействие в группах**:
    - Бот отслеживает сообщения от клиентов (не сотрудников).
    - Когда сотрудник отвечает на сообщение клиента (через функцию "Ответить" в Telegram), бот фиксирует ответ.

### Веб-интерфейс

- **Вход**:
    1. Перейдите по адресу вашего веб-сервера (например, `http://localhost:8000` или `https://your.domain.com`).
    2. Нажмите "Войти через Telegram".
    3. Введите свой Telegram ID (бот подскажет его по команде `/start`).
    4. Нажмите "Отправить код".
    5. Бот пришлет вам в личные сообщения 6-значный код.
    6. Введите код на странице входа.
- **Админ-панель (`/admin` или `/dashboard` для админа)**:
    - Просмотр общей статистики.
    - Управление сотрудниками: добавление, редактирование, активация/деактивация.
    - Доступ к странице настроек системы (`/settings`).
    - Просмотр детальной статистики по всем сотрудникам (`/statistics`).
- **Личный кабинет сотрудника (`/dashboard`)**:
    - Просмотр личной статистики.
    - Список последних сообщений.

## Настройка и Кастомизация

- **Переменные окружения (`.env`)**: Основной способ конфигурации.
- **Время уведомлений**: Настраивается через переменные `RESPONSE_TIME_WARNING_1`, `RESPONSE_TIME_WARNING_2`, `RESPONSE_TIME_WARNING_3` в `.env` (в минутах).
- **Google Sheets Экспорт**: (Если включено `GOOGLE_SHEETS_ENABLED=True`)
    - Настройте `google_sheets_credentials_file` (путь к JSON файлу с учетными данными сервисного аккаунта Google Cloud) и `spreadsheet_id` (ID вашей Google Таблицы).
    - Предоставьте сервисному аккаунту права на редактирование вашей таблицы.

### Подробная настройка Google Sheets интеграции

Если вы хотите включить экспорт статистики в Google Sheets, выполните следующие шаги:

#### 1. Создание проекта в Google Cloud Console

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Создайте новый проект или выберите существующий:
   - Нажмите на название проекта в верхней части экрана
   - Нажмите "Новый проект"
   - Введите название проекта (например, "Activity Tracker")
   - Нажмите "Создать"

#### 2. Включение Google Sheets API

1. В боковом меню выберите "API и сервисы" → "Библиотека"
2. Найдите "Google Sheets API"
3. Нажмите на него и нажмите "Включить"

#### 3. Создание сервисного аккаунта

1. Перейдите в "API и сервисы" → "Учетные данные"
2. Нажмите "Создать учетные данные" → "Аккаунт службы"
3. Заполните форму:
   - **Название аккаунта службы**: `activity-tracker-service`
   - **Описание**: `Сервисный аккаунт для Activity Tracker Pro`
4. Нажмите "Создать и продолжить"
5. В поле "Роль" выберите "Редактор" (или создайте кастомную роль с доступом к Sheets)
6. Нажмите "Готово"

#### 4. Создание и скачивание ключа

1. В списке сервисных аккаунтов найдите созданный аккаунт
2. Нажмите на него
3. Перейдите на вкладку "Ключи"
4. Нажмите "Добавить ключ" → "Создать новый ключ"
5. Выберите тип "JSON"
6. Нажмите "Создать"
7. Файл JSON автоматически скачается на ваш компьютер

#### 5. Размещение файла credentials

1. Переименуйте скачанный файл в `credentials.json`
2. Поместите файл в корневую папку проекта (рядом с `README.md`)
3. **ВАЖНО!** Убедитесь, что файл `credentials.json` добавлен в `.gitignore` (уже добавлен по умолчанию)

#### 6. Создание Google Таблицы

1. Перейдите в [Google Sheets](https://sheets.google.com/)
2. Создайте новую таблицу
3. Дайте ей название (например, "Activity Tracker Statistics")
4. Скопируйте ID таблицы из URL:
   - URL выглядит как: `https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit`
   - Скопируйте часть `SPREADSHEET_ID`

#### 7. Предоставление доступа сервисному аккаунту

1. Откройте файл `credentials.json` в текстовом редакторе
2. Найдите поле `"client_email"` и скопируйте email адрес
3. В Google Таблице нажмите "Настроить доступ" (кнопка в правом верхнем углу)
4. Вставьте email сервисного аккаунта
5. Выберите права "Редактор"
6. Нажмите "Отправить"

#### 8. Настройка переменных окружения

Добавьте в файл `.env`:

```bash
# Google Sheets Integration
GOOGLE_SHEETS_ENABLED=True
GOOGLE_SHEETS_CREDENTIALS_FILE=credentials.json
GOOGLE_SHEETS_SPREADSHEET_ID=ваш_spreadsheet_id_из_шага_6
```

#### 9. Проверка работы

1. Запустите бота и веб-интерфейс
2. Убедитесь, что в логах нет ошибок связанных с Google Sheets
3. Проверьте, что данные появляются в Google Таблице

#### Возможные проблемы и решения

- **Ошибка "403 Forbidden"**: Убедитесь, что Google Sheets API включен в проекте
- **Ошибка "Spreadsheet not found"**: Проверьте правильность ID таблицы и доступ сервисного аккаунта
- **Ошибка "Credentials not found"**: Убедитесь, что путь к файлу `credentials.json` указан правильно

## Возможные доработки

- Более гранулированные права доступа.
- Назначение чатов конкретным сотрудникам.
- Расширенная отчетность и фильтры в веб-интерфейсе.
- Интеграция с другими системами (CRM, HelpDesk).

## Контрибьюция

Будем рады вашему вкладу! Пожалуйста, придерживайтесь принятого стиля кодирования и создавайте pull request'ы в ветку `main` или `develop` (если такая используется). 